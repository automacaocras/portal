<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

<title>Portal do Professor ‚Äì Editora Cr√°s</title>
<meta name="description" content="Acompanhe feedbacks, aulas gravadas e envios de exerc√≠cios.">

<!-- Favicons -->
<link rel="icon" type="image/png" href="assets/favicon.png" sizes="32x32">
<link rel="apple-touch-icon" href="assets/apple-touch-icon.png" sizes="180x180">
<link rel="shortcut icon" href="assets/favicon.ico">
<meta name="theme-color" content="#0286ff">

<!-- Open Graph -->
<meta property="og:type" content="website">
<meta property="og:site_name" content="Editora Cr√°s">
<meta property="og:locale" content="pt_BR">
<meta property="og:title" content="Portal do Professor ‚Äì Editora Cr√°s">
<meta property="og:description" content="Acompanhe feedbacks, aulas gravadas e envios de exerc√≠cios.">

<!-- ‚úÖ Ajuste o URL abaixo conforme a p√°gina -->
<link rel="canonical" href="http://areadosartistas.com.br/portalprofessor.html">
<meta property="og:url" content="http://areadosartistas.com.br/portalprofessor.html">

<!-- ‚úÖ Imagem correta no GitHub Pages -->
<meta property="og:image" content="http://areadosartistas.com.br/assets/wppcompartilhar.png">
<meta property="og:image:secure_url" content="http://areadosartistas.com.br/assets/wppcompartilhar.png">
<meta property="og:image:type" content="image/png">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">

<!-- Guard: exige sess√£o e perfil professor (executa o quanto antes) -->
<script>
  (function enforceProfessorRole() {
    try {
      const raw = localStorage.getItem("sessao_portal");
      const sess = raw ? JSON.parse(raw) : null;

      if (!sess || !sess.email || !sess.curso) {
        alert("Fa√ßa login para acessar.");
        location.replace("index.html");
        return;
      }

      if (String(sess.perfil || "").toLowerCase() !== "professor") {
        localStorage.removeItem("sessao_portal");
        alert("Acesso de professor n√£o validado. Fa√ßa login novamente.");
        location.replace("index.html");
        return;
      }

      if (location.search) history.replaceState({}, "", location.pathname);
    } catch (e) {
      console.error(e);
      alert("Sess√£o inv√°lida. Fa√ßa login novamente.");
      localStorage.removeItem("sessao_portal");
      location.replace("index.html");
    }
  })();
</script>

<link rel="stylesheet" href="style.css?v=3">

<style>
  /* ===== corre√ß√µes de layout/overflow ===== */
  * { box-sizing: border-box; }
  html, body { overflow-x: hidden; }

  /* topbar sem usar 100vw para evitar ‚Äúbleed‚Äù lateral */
  .topbar{
    width:auto;
    margin-left: calc(-1 * var(--gutter, 0px));
    margin-right: calc(-1 * var(--gutter, 0px));
    background:#f4c200;color:#000;font-weight:800;text-align:center;
    padding:14px 0;box-shadow:inset 0 -2px 0 rgba(0,0,0,.08);
  }

  .wrap{max-width:900px;margin:20px auto;}
  .band{max-width:900px;margin:12px auto;display:flex;flex-direction:column;gap:12px}
  .btn-band{display:block;width:100%;padding:16px 18px;border:none;border-radius:12px;
    font-weight:800;cursor:pointer;text-align:center;color:#fff}
  .btn-live{background:#ff6b6b}
  .btn-grav{background:#ff9f45}
  .panel{background:#fff;border:1px solid #f2e3a6;border-radius:18px;padding:18px;
    box-shadow:0 8px 24px rgba(0,0,0,.06)}
  .panel h3{margin:0 0 10px;text-align:center}
  .links-box a{display:block;word-break:break-all;margin:8px 0;padding:10px 12px;
    background:#f7f7ff;border-radius:10px;text-decoration:underline;color:#1d2433;text-align:center}
  .field{margin:10px auto;max-width:720px}
 .field input,
.field textarea,
.field select{
  width:100%;
  padding:12px;
  border:1px solid #cfd6e4;
  border-radius:10px;
  background:#fff;
  font-size:16px;
}
  .field textarea{min-height:110px}
  .btn-primary{display:block;width:100%;max-width:420px;margin:18px auto 6px;padding:14px 18px;
    border:none;border-radius:12px;background:#f4c200;color:#111;font-weight:800;cursor:pointer}
  .btn-neutral{display:block;width:100%;max-width:320px;margin:10px auto;padding:12px 18px;
    border:none;border-radius:12px;background:#ddd;color:#111;font-weight:800;cursor:pointer}
  .btn-exit{display:block;width:140px;margin:18px auto 0;padding:12px 18px;border:none;
    border-radius:12px;background:#d64545;color:#fff;font-weight:800;cursor:pointer}
  .hidden{display:none !important}
  .next-live, .gravada-info{ text-align:center; margin:8px 0 14px; }
  .next-live strong, .gravada-info strong{ font-weight:800; }
  .live-link{ display:inline-block; margin-top:4px; text-decoration:underline; }
  .is-invalid{
    border-color:#d64545 !important;
    box-shadow:0 0 0 2px rgba(214,69,69,.12);
    outline: none;
  }

  /* ====== TABELA (somente leitura) ====== */
  .table-wrap{
    overflow-x:auto;
    overflow-y:visible;
    -webkit-overflow-scrolling:touch;
    max-width:100%;
    border:1px solid #eee;
    border-radius:12px;
  }
  #exTable{
    border-collapse:collapse;
    table-layout:auto;
    width:max-content;
    min-width:760px;
  }
  /* padding mais apertado pra tirar o ‚Äúespa√ßo vazio‚Äù */
 #exTable th,
#exTable td {
  border-bottom: 1px solid #eee;
  padding: 2px 4px;       
  text-align: left;
  font-size: 13px;        /* levemente menor */
  vertical-align: middle;
  line-height: 1;         
}


  #exTable th { position:sticky; top:0; background:#fff; z-index:1; }
  #exTable a { word-break:break-all }

  .cell-clip{
    display:block;
    max-width: 280px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  @media (min-width: 900px){
    .cell-clip{ max-width: 420px; }
  }
  td .cell-clip a{
    display:inline-block; max-width:100%;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }

  .preview-pop{
    position: fixed;
    z-index: 9999;
    max-width: min(80vw, 640px);
    background: #f7f9ff;
    border: 1px solid #cfd6e4;
    padding: 10px 12px;
    border-radius: 10px;
    box-shadow: 0 8px 24px rgba(0,0,0,.15);
    font-size: 14px;
    line-height: 1.35;
    color:#111;
  }

  .controls-bottom{
    display:flex; flex-direction:column; align-items:center; gap:6px;
    margin-top:14px;
  }
  .btn-refresh{
    display:inline-block; padding:14px 22px; border:none; border-radius:12px;
    background:#ddd; color:#111; font-weight:800; cursor:pointer; width:min(320px, 90%);
  }
  .small-muted{color:#555;font-size:14px}

  #global-loading {
    position: fixed;
    inset: 0;
    display: none;
    place-items: center;
    z-index: 2147483647;
    background: rgba(0,0,0,0.45);
    backdrop-filter: blur(8px) saturate(120%);
    -webkit-backdrop-filter: blur(8px) saturate(120%);
    will-change: backdrop-filter;
  }
  .global-loading-bubble {
    background: #fff;
    padding: 16px 22px;
    border-radius: 12px;
    font-weight: 700;
    font-size: 18px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.20);
  }

  .band + .gravada-info { margin-top: 6px; }

  #prof-exercicios { margin-left:auto; margin-right:auto; }
  #prof-exercicios .table-wrap { margin: 0 auto; max-width: 100%; }

  @media (max-width:480px){
    .wrap{ margin:16px auto; }
    .panel{ padding:14px; }
    .btn-band{ padding:14px 12px; font-size:15px; }
    .cell-clip{ max-width:180px; }
  }

  /* ===== Modal de visualiza√ß√£o de exerc√≠cio ===== */
.ex-modal {
  position: fixed;
  inset: 0;
  z-index: 10000;
  display: none;
  align-items: center;
  justify-content: center;
}

.ex-modal.is-open {
  display: flex;
}

.ex-modal-backdrop {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.65);
}

.ex-modal-dialog {
  position: relative;
  max-width: min(900px, 92vw);
  max-height: 92vh;
  background: #fff;
  border-radius: 18px;
  box-shadow: 0 14px 36px rgba(0,0,0,0.35);
  padding: 18px 22px 16px;
  display: flex;
  flex-direction: column;
  overflow: auto;
  z-index: 1;
}

.ex-modal-close {
  position: absolute;
  top: 10px;
  right: 14px;
  border: none;
  background: transparent;
  font-size: 24px;
  cursor: pointer;
}

.ex-modal-header { margin-bottom: 12px; }
#exModalTitle { font-size: 18px; font-weight: 700; }
#exModalSub { font-size: 14px; color:#555; }

.ex-modal-body {
  position: relative;
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}

#exModalImg {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
}

  #exModalFrame {
  width: 100%;
  height: 100%;
  border: none;
}
  
.ex-nav {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  border: none;
  background: rgba(0,0,0,0.35);
  color: #fff;
  width: 38px;
  height: 48px;
  border-radius: 24px;
  cursor: pointer;
  font-size: 26px;
}

.ex-nav-prev { left: 8px; }
.ex-nav-next { right: 8px; }

/* footer do modal */
.ex-modal-footer {
  margin-top: 10px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

#exModalDesc { font-size: 14px; line-height: 1.4; }

.ex-modal-actions {
  display: flex;
  width: 100%;
  gap: 0;                /* tira o espa√ßo branco entre eles */
  flex-wrap: nowrap;     /* mant√©m tudo em uma linha s√≥ */
}

.ex-modal-actions button {
  border: none;
  padding: 14px 0;       /* mais ‚Äúbot√£oz√£o‚Äù horizontal */
  font-weight: 600;
  cursor: pointer;
  flex: 1 1 0;           /* cada um ocupa metade da largura */
  max-width: none;       /* sem limite de largura */
  border-radius: 0;      /* sem arredondar individualmente */
}

/* Se quiser as pontas externas levemente arredondadas, mant√©m o bloco acima e adiciona: */
.ex-modal-actions button:first-child {
  border-radius: 999px 0 0 999px;
}

.ex-modal-actions button:last-child {
  border-radius: 0 999px 999px 0;
}



#exBtnOpen {
  background: #f4c200;
  color: #111;
}

#exBtnDownload {
  background:#111;
  color:#fff;
}


/* Bot√£o "Envio 1/2/3" */
.ex-link-btn {
  background:none;
  border:none;
  padding:0;
  color:#0066cc;
  text-decoration:underline;
  cursor:pointer;
  font:inherit;
}

/* MOBILE */
@media (max-width: 600px) {
  .ex-modal-dialog {
    width: 100%;
    max-width: 100%;
    padding: 14px 12px;
    border-radius: 12px;
  }
  .ex-modal-body {
    max-height: 60vh;
  }
}
</style>
</head>
<body>

<div class="topbar" id="topbar">[professor]</div>

<main class="page-center" style="--center-offset:-40px;">
  <div class="wrap">

    <!-- HOME -->
    <section id="home">

      <h2 style="text-align:center;margin:8px 0 6px">√Årea do professor</h2>
      <br><br>

      <p id="nextLive" class="next-live hidden">
        <strong>Pr√≥ximo evento ao vivo:</strong><br>
        <span id="nextLiveText">‚Äî</span><br>
        <a id="nextLiveHref" href="#" target="_blank" rel="noopener" class="live-link hidden"></a>
      </p>

      <div class="band">
        <button class="btn-band btn-live" id="btnAbrirLive" data-busy>Atualizar pr√≥xima aula ao vivo</button>
        <button class="btn-band btn-grav" id="btnAbrirGrav" data-busy>Atualizar link do feedback gravado</button>
      </div>
      
      <p id="gravadaInfo" class="gravada-info hidden">
        <strong>Aula gravada:</strong>
        <a id="gravadaHref" href="#" target="_blank" rel="noopener"></a>
      </p>

      <!-- Exerc√≠cios enviados (somente leitura) -->
      <section id="prof-exercicios" class="panel" style="max-width:1100px">
        <h3 style="margin-top:0">Exerc√≠cios para feedback:</h3>

        <div class="table-wrap">
          <table id="exTable">
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="controls-bottom">
          <button id="exAtualizar" class="btn-refresh" type="button" data-busy>Atualizar</button>
          <div class="small-muted" id="exTotalText">Total 0 exerc√≠cios</div>
        </div>
      </section>

      <br>

      <section class="panel" id="linksPanel">
        <h3>Links √öteis:</h3>
        <div class="links-box">
          <a href="https://drive.google.com/drive/folders/1WLXyVj5PXzm1ZOaCjWLvUctu_aoYohUV"
             target="_blank" rel="noopener">Pasta Central do Drive</a>
          <a href="https://chat.whatsapp.com/E8ruCXpqoK5122AWBGowwp"
             target="_blank" rel="noopener">Grupo dos alunos no Whatsapp</a>
          <a href="https://areadosartistas.com.br/faq.html"
             target="_blank" rel="noopener">FAQ da plataforma</a>
        </div>
      </section>

      <button id="btnSair" class="btn-exit" data-busy>Sair</button>
    </section>

    <!-- FORM: Pr√≥xima aula ao vivo -->
    <section id="formLive" class="panel hidden">
      <h3>Pr√≥xima aula ao vivo</h3>
      <div class="field"><input   id="fLink"  placeholder="Link"></div>
      <div class="field"><input   id="fSenha" placeholder="Senha"></div>
      <div class="field">
        <select id="fHora">
          <option value="">Selecione o hor√°rio</option>
          <!-- op√ß√µes ser√£o preenchidas via JS -->
        </select>
      </div>

      <div class="field">
        <select id="fDia">
          <option value="">Selecione o dia</option>
          <option value="segunda-feira">Segunda-feira</option>
          <option value="ter√ßa-feira">Ter√ßa-feira</option>
          <option value="quarta-feira">Quarta-feira</option>
          <option value="quinta-feira">Quinta-feira</option>
          <option value="sexta-feira">Sexta-feira</option>
          <option value="s√°bado">S√°bado</option>
          <option value="domingo">Domingo</option>
        </select>
      </div>

      <div class="field"><textarea id="fInfo"  placeholder="Info"></textarea></div>

      <button id="btnEnviarLive" class="btn-primary" data-busy>Atualizar</button>
      <p style="text-align:center;">
        Apenas atualize as informa√ß√µes ap√≥s o evento ao vivo anterior ter sido finalizado.
      </p>
      <button id="btnVoltar1" class="btn-neutral" type="button" data-busy>Voltar</button>
    </section>

    <!-- FORM: Aula gravada -->
    <section id="formGrav" class="panel hidden">
      <h3>Atualizar link do feedback gravado</h3>
      <div class="field"><input id="fGravada" placeholder="Link do feedback gravado"></div>

      <button id="btnEnviarGrav" class="btn-primary" data-busy>Atualizar</button>
      <button id="btnVoltar2" class="btn-neutral" type="button" data-busy>Voltar</button>
    </section>

  </div>
</main>

<footer class="site-footer">
  <div class="footer-inner">
    <strong>Editora Cr√°s ‚Ä¢ </strong>
    <a href="mailto:contato@editoracras.com">Suporte</a>
    <small>¬© 2025. Todos os direitos reservados.</small>
  </div>
</footer>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbwQ9utyV79uWjpVHuBRWbie_2kkgTX-lPBudob49WA2daqn5qdbdqyzhl3LqYC0y_fVuQ/exec";

  const qs  = s => document.querySelector(s);
  const show = el => el.classList.remove('hidden');
  const hide = el => el.classList.add('hidden');

  let sessao = null, bootstrap = null;
  let exercisesData = [];
  let modalState = {
    rowIndex: null,
    images: [],
    currentIdx: 0
  };

  function validEmail(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v); }

  function isValidURL(url){
    try{ const u = new URL(url); return u.protocol === 'http:' || u.protocol === 'https:'; }
    catch{ return false; }
  }
 
  function markInvalid(el, state=true){ if (!el) return; el.classList.toggle('is-invalid', !!state); }
  function clearInvalidOnInput(sel){
    const el = qs(sel); if (!el) return;
    el.addEventListener('input', ()=> markInvalid(el,false));
    el.addEventListener('blur',  ()=> markInvalid(el,false));
    el.addEventListener('change',()=> markInvalid(el,false));
  }

  function populateHoraSelect(){
    const sel = qs('#fHora');
    if (!sel) return;

    sel.innerHTML = '<option value="">Selecione o hor√°rio</option>';

    for (let h = 0; h < 24; h++){
      for (let m = 0; m < 60; m += 30){
        const hh = String(h).padStart(2, '0');
        const mm = String(m).padStart(2, '0');
        const value = `${hh}:${mm}`;
        const opt = document.createElement('option');
        opt.value = value;
        opt.textContent = value;
        sel.appendChild(opt);
      }
    }
  }

  function validateLiveForm(){
    const fLink = qs('#fLink'),
          fHora = qs('#fHora'),
          fDia  = qs('#fDia');

    const link = fLink.value.trim(),
          hora = fHora.value.trim(),
          dia  = fDia.value.trim();

    [fLink, fHora, fDia].forEach(el => markInvalid(el,false));
    const errors = [];

    if (!link || !isValidURL(link)){
      errors.push('‚Ä¢ Informe um LINK v√°lido (http/https).');
      markInvalid(fLink,true);
    }
    if (!hora){
      errors.push('‚Ä¢ Selecione a HORA da aula.');
      markInvalid(fHora,true);
    }
    if (!dia){
      errors.push('‚Ä¢ Selecione o DIA da aula.');
      markInvalid(fDia,true);
    }

    if (errors.length){
      alert('Verifique os campos obrigat√≥rios:\n\n' + errors.join('\n'));
      const firstInvalid = [fLink,fHora,fDia].find(el => el.classList.contains('is-invalid'));
      if (firstInvalid) firstInvalid.focus();
      return false;
    }
    return { link, hora, dia };
  }

  function renderNextLive(src){
    const box = qs('#nextLive'), txt = qs('#nextLiveText'), a = qs('#nextLiveHref');

    const dia  = String(src?.dia || '').trim();
    const hora = String(src?.hora || '').trim();
    const prof = String(src?.professor || '').trim();
    const link = String(src?.link || '').trim();

    const parts = [];
    if (dia)  parts.push(dia);
    if (hora) parts.push(hora);

    let texto = parts.join(', ');
    if (texto && prof) texto += ' com ' + prof;

    const hasText = !!texto;
    const hasLink = !!link;

    txt.textContent = hasText ? texto : '‚Äî';

    if (hasLink){
      a.textContent = link;
      a.href = link;
      a.classList.remove('hidden');
    } else {
      a.textContent = '';
      a.removeAttribute('href');
      a.classList.add('hidden');
    }

    box.classList.toggle('hidden', !(hasText || hasLink));
  }

  function renderGravada(src){
    const p = qs('#gravadaInfo'), a = qs('#gravadaHref'), url = String(src?.aulaGravada || '').trim();
    if (url){ a.textContent = url; a.href = url; p.classList.remove('hidden'); }
    else { a.textContent = ''; a.removeAttribute('href'); p.classList.add('hidden'); }
  }

  /* ===== helpers para clip + popover ===== */
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function stripTags(html){
    const tmp = document.createElement('div');
    tmp.innerHTML = html;
    return tmp.textContent || tmp.innerText || '';
  }
  function wrapClipHTML(innerHTML){
    const fullTxt = stripTags(innerHTML);
    return `<div class="cell-clip" data-full="${escapeHtml(fullTxt)}">${innerHTML}</div>`;
  }

  /* ========= Apenas a coluna "Descri√ß√£o" fica menor (colgroup din√¢mico) ========= */
  function setDescricaoWidth(headers, desktopWidth = "320px", mobileWidth = "200px"){
    const table = document.getElementById("exTable");
    if (!table || !headers || !headers.length) return;

    const descIndex = headers.findIndex(h => /descr/i.test(String(h)));
    if (descIndex === -1) return;

    const old = table.querySelector("colgroup");
    if (old) old.remove();

    const isMobile = window.matchMedia("(max-width: 480px)").matches;
    const width = isMobile ? mobileWidth : desktopWidth;

    const cg = document.createElement("colgroup");
    headers.forEach((_, i) => {
      const col = document.createElement("col");
      if (i === descIndex){
        col.style.width = width;
        col.style.minWidth = width;
        col.style.maxWidth = width;
      }
      cg.appendChild(col);
    });

    table.insertBefore(cg, table.firstChild);
  }

  function attachOverflowPreview(){
    const root = document.querySelector('#exTable');
    if (!root) return;

    let pop = null;

    function show(e){
      const clip = e.currentTarget;
      if (clip.scrollWidth <= clip.clientWidth) return;
      if (pop) pop.remove();
      pop = document.createElement('div');
      pop.className = 'preview-pop';
      pop.textContent = clip.dataset.full || clip.textContent || '';
      document.body.appendChild(pop);
      position(e);
    }
    function position(e){
      if (!pop) return;
      const pad = 8;
      let x = (e.clientX || 20) + 14;
      let y = (e.clientY || 20) + 14;
      const vw = window.innerWidth, vh = window.innerHeight;
      const r = pop.getBoundingClientRect();
      if (x + r.width  + pad > vw) x = vw - r.width  - pad;
      if (y + r.height + pad > vh) y = vh - r.height - pad;
      pop.style.left = x + 'px';
      pop.style.top  = y + 'px';
    }
    function hide(){ if (pop){ pop.remove(); pop = null; } }

    root.querySelectorAll('.cell-clip').forEach(el=>{
      el.addEventListener('mouseenter', show);
      el.addEventListener('mousemove', position);
      el.addEventListener('mouseleave', hide);
      el.addEventListener('click', show);
    });
    document.addEventListener('touchstart', () => { if (pop) { pop.remove(); pop=null; } }, {passive:true});
  }

  function attachModalTriggers() {
    document.querySelectorAll(".ex-link-btn").forEach(btn => {
      btn.addEventListener("click", e => {
        const rowIndex = parseInt(e.currentTarget.dataset.rowIndex || "0", 10);
        const imgIndex = parseInt(e.currentTarget.dataset.imgIndex || "1", 10);
        openExerciseModal(rowIndex, imgIndex);
      });
    });
  }

  // ====== Exerc√≠cios ‚Äì carregar tudo (sem pagina√ß√£o) ======
  const PAGE_SIZE = 100000;

  function isLinkCol(h){
    return /\blink/i.test(String(h || ""));
  }
  function linkLabelFromHeader(h){
    const m = String(h || "").match(/\d+/);
    return m ? `Envio ${m[0]}` : "Envio";
  }
  function renderCellHTML(header, value){
    const s = String(value || "").trim();
    if (!s) return "";
    if (isLinkCol(header) && /^https?:\/\//i.test(s)){
      const label = linkLabelFromHeader(header);
      return `<a href="${s}" target="_blank" rel="noopener">${label}</a>`;
    }
    if (/^https?:\/\//i.test(s)) return `<a href="${s}" target="_blank" rel="noopener">${s}</a>`;
    return s;
  }
  function needsClip(h){
    return /descr/i.test(String(h || ""));
  }

  async function fetchExercisesPreview() {
    try {
      setLoading(true, "Carregando exerc√≠cios‚Ä¶");

      const params = new URLSearchParams({
        action: "listExercisesPreview",
        curso:  sessao.curso,
        email:  sessao.email,
        limit:  PAGE_SIZE,
        offset: 0
      });

      const r = await fetch(`${API_URL}?${params.toString()}`, { cache: 'no-store' });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      const d = await r.json();
      if (!d.ok) throw new Error(d.message || "Falha ao listar exerc√≠cios.");

      // Cabe√ßalho da tabela
      const thead = document.querySelector("#exTable thead");
      thead.innerHTML = "";
      const trh = document.createElement("tr");
      (d.headers || []).forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        trh.appendChild(th);
      });
      thead.appendChild(trh);

      // Cache de headers para o modal
      if (!bootstrap) bootstrap = {};
      bootstrap.headersCache = d.headers || [];

      setDescricaoWidth(bootstrap.headersCache);

      // Corpo da tabela
      const tbody = document.querySelector("#exTable tbody");
      tbody.innerHTML = "";

      // guarda todas as linhas para o modal
      exercisesData = d.rows || [];

      (d.rows || []).forEach((row, rowIndex) => {
        const tr = document.createElement("tr");

        (d.headers || []).forEach(h => {
          const td = document.createElement("td");
          const rawValue = row[h];
          const s = String(rawValue || "").trim();

          if (!s) {
            td.textContent = "";
            tr.appendChild(td);
            return;
          }

          if (isLinkCol(h) && /^https?:\/\//i.test(s)) {
            // coluna de link de imagem -> bot√£o "Envio X"
            const imgIdx = parseInt((h.match(/\d+/) || ["1"])[0], 10);
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "ex-link-btn";
            btn.textContent = linkLabelFromHeader(h);
            btn.dataset.rowIndex = rowIndex;
            btn.dataset.imgIndex = imgIdx;
            td.appendChild(btn);
          } else {
            // outras colunas normais
            const html = renderCellHTML(h, rawValue);
            td.innerHTML = needsClip(h) ? wrapClipHTML(html) : html;
          }

          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });

      // textos longos com tooltip
      attachOverflowPreview();
      // conecta cliques dos bot√µes "Envio X" ao modal
      attachModalTriggers();

      // Total de exerc√≠cios
      const total = d.totalRows || 0;
      const label = total === 1 ? "exerc√≠cio" : "exerc√≠cios";
      document.getElementById("exTotalText").textContent = `Total ${total} ${label}`;

      // Nenhum envio
      if ((d.rows || []).length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = (d.headers || []).length || 1;
        td.style.textAlign = "center";
        td.style.color = "#666";
        td.textContent = "Nenhum envio encontrado.";
        tr.appendChild(td);
        tbody.appendChild(tr);
      }

    } catch (e) {
      alert("Erro: " + e.message);
    } finally {
      setLoading(false);
    }
  }

  document.addEventListener('DOMContentLoaded', boot);

  async function boot(){
    try { sessao = JSON.parse(localStorage.getItem('sessao_portal') || 'null'); } catch {}
    if (!sessao || !validEmail(sessao.email) || !sessao.curso) {
      alert('Fa√ßa login para acessar.');
      location.replace('index.html');
      return;
    }

    setLoading(true, "Carregando painel‚Ä¶");
    const resp = await fetch(`${API_URL}?action=portalBootstrap&curso=${encodeURIComponent(sessao.curso)}&email=${encodeURIComponent(sessao.email)}`, { cache:'no-store' });
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    bootstrap = await resp.json();
    setLoading(false);

    if (!bootstrap || bootstrap.allowed !== true || String(bootstrap.perfil).toLowerCase() !== 'professor') {
      alert('Acesso de professor n√£o validado. Fa√ßa login novamente.');
      location.replace('index.html');
      return;
    }

    qs('#topbar').textContent = `[${bootstrap.nome || 'professor'}]`;

    if (bootstrap?.feedback){
      renderNextLive(bootstrap.feedback);
      renderGravada(bootstrap.feedback);
    }
    populateHoraSelect();

    qs('#btnAbrirLive').addEventListener('click', () => { hide(qs('#home')); show(qs('#formLive')); window.scrollTo({top:0,behavior:'smooth'}); });
    qs('#btnAbrirGrav').addEventListener('click', () => { hide(qs('#home')); show(qs('#formGrav')); window.scrollTo({top:0,behavior:'smooth'}); });
    qs('#btnVoltar1').addEventListener('click', goHome);
    qs('#btnVoltar2').addEventListener('click', goHome);
    qs('#btnSair').addEventListener('click', () => { localStorage.removeItem('sessao_portal'); location.replace('index.html'); });

    qs('#btnEnviarLive').addEventListener('click', enviarLive);
    qs('#btnEnviarGrav').addEventListener('click', enviarGrav);

    document.getElementById("exAtualizar").addEventListener("click", fetchExercisesPreview);

    fetchExercisesPreview();

    window.addEventListener("resize", () => setDescricaoWidth( (bootstrap?.headersCache || []) ));

    ['#fLink','#fHora','#fDia'].forEach(clearInvalidOnInput);
  }

  function clearForms(){
    ['#fLink','#fSenha','#fHora','#fDia','#fInfo','#fGravada'].forEach(sel=>{
      const el = qs(sel); if (el) { el.value = ''; markInvalid(el,false); }
    });
  }

  function goHome(){
    hide(qs('#formLive')); hide(qs('#formGrav'));
    show(qs('#home'));
    clearForms();
    history.replaceState({}, "", location.pathname);
    window.scrollTo({top:0,behavior:'smooth'});
  }

  async function enviarLive(){
    const ok = validateLiveForm();
    if (!ok) return;

    const body = new URLSearchParams({
      action: 'updateFeedbackLive',
      curso:  sessao.curso,
      email:  sessao.email,
      link:   qs('#fLink').value.trim(),
      senha:  qs('#fSenha').value.trim(),
      hora:   qs('#fHora').value.trim(),
      dia:    qs('#fDia').value.trim(),
      info:   qs('#fInfo').value.trim()
    });

    setLoading(true, "Atualizando informa√ß√µes‚Ä¶");
    try{
      const r = await fetch(API_URL, { method:'POST', body });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      const data = await r.json();
      if (!data || data.ok !== true) throw new Error((data && (data.message || data.error)) || 'Falha ao atualizar');

      renderNextLive({
        dia:  qs('#fDia').value.trim(),
        hora: qs('#fHora').value.trim(),
        professor: bootstrap?.nome || '',
        link: qs('#fLink').value.trim()
      });

      goHome();
      setTimeout(()=>alert('Pr√≥xima aula ao vivo atualizada!'), 50);
    }catch(e){
      alert('Erro ao atualizar: ' + e.message);
    }finally{
      setLoading(false);
    }
  }

  async function enviarGrav(){
    const body = new URLSearchParams({
      action: 'updateGravada',
      curso:  sessao.curso,
      email:  sessao.email,
      aulaGravada: qs('#fGravada').value.trim()
    });

    setLoading(true, "Atualizando aula gravada‚Ä¶");
    try{
      const r = await fetch(API_URL, { method:'POST', body });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      const data = await r.json();
      if (!data || data.ok !== true) throw new Error((data && (data.message || data.error)) || 'Falha ao atualizar');

      renderGravada({ aulaGravada: qs('#fGravada').value.trim() });
      goHome();
      setTimeout(()=>alert('Link da aula gravada atualizado!'), 50);
    }catch(e){
      alert('Erro ao atualizar: ' + e.message);
    }finally{
      setLoading(false);
    }
  }

  function buildImagesArrayForRow(row) {
    const images = [];
    (bootstrap?.headersCache || []).forEach(h => {
      if (isLinkCol(h)) {
        const url = row[h];
        if (url) images.push(url);
      }
    });
    return images;
  }

  function openExerciseModal(rowIndex, imgIndexFrom1) {
    const row = exercisesData[rowIndex];
    if (!row) return;

    modalState.rowIndex = rowIndex;
    modalState.images = buildImagesArrayForRow(row);
    modalState.currentIdx = (imgIndexFrom1 - 1) || 0;

    const nome   = row["Nome"] || "";
    const modulo = row["M√≥dulo"] || row["Modulo"] || "";
    const aula   = row["Aula"] || "";
    const desc   = row["Descri√ß√£o"] || row["Descricao"] || "";

    document.getElementById("exModalTitle").textContent = nome;
    document.getElementById("exModalSub").textContent = [modulo, aula].filter(Boolean).join(" - ");
    document.getElementById("exModalDesc").textContent = desc;

    // mostra as setas s√≥ se tiver mais de uma imagem
    const hasMany = modalState.images.length > 1;
    const prevBtn = document.querySelector('.ex-nav-prev');
    const nextBtn = document.querySelector('.ex-nav-next');
    if (prevBtn) prevBtn.style.display = hasMany ? 'block' : 'none';
    if (nextBtn) nextBtn.style.display = hasMany ? 'block' : 'none';

    updateModalImage();
    showExerciseModal();
  }

  // Extrai poss√≠veis URLs de imagem a partir de um link do Drive
  function buildDriveCandidates(url) {
    if (!url) return [];

    let candidates = [];

    try {
      const u = new URL(url);

      // se n√£o for Drive, s√≥ devolve o pr√≥prio link
      if (!u.hostname.includes("drive.google.com")) {
        return [url];
      }

      let fileId = null;

      // /file/d/ARQUIVO_ID/view
      const match1 = u.pathname.match(/\/file\/d\/([^/]+)/);
      if (match1 && match1[1]) {
        fileId = match1[1];
      }

      // ?id=ARQUIVO_ID
      if (!fileId) {
        const idParam = u.searchParams.get("id");
        if (idParam) fileId = idParam;
      }

      if (fileId) {
        const viewUrl = `https://drive.google.com/uc?export=view&id=${fileId}`;
        const thumbUrl = `https://drive.google.com/thumbnail?id=${fileId}&sz=w1000`;

        // ordem de tentativas: view inteira -> thumb -> original
        candidates = [viewUrl, thumbUrl, url];
      } else {
        candidates = [url];
      }
    } catch (e) {
      // se der erro no new URL(), cai no original
      candidates = [url];
    }

    return candidates;
  }

  function updateModalImage() {
    const imgEl = document.getElementById("exModalImg");
    const rawUrl = modalState.images[modalState.currentIdx];

    if (!imgEl || !rawUrl) {
      console.warn("Sem imagem para exibir:", { imgEl, rawUrl });
      return;
    }

    const candidates = buildDriveCandidates(rawUrl);
    let attemptIndex = 0;

    if (!candidates.length) {
      imgEl.style.display = "none";
      return;
    }

    imgEl.style.display = "block";

    function tryLoadNext() {
      const urlToLoad = candidates[attemptIndex];
      if (!urlToLoad) {
        console.warn("Nenhuma URL de imagem funcionou para:", rawUrl);
        imgEl.style.display = "none";
        return;
      }

      console.log("üîé ExModal tentando URL:", {
        rawUrl,
        attemptIndex,
        urlToLoad
      });

      imgEl.onerror = function () {
        console.warn("Erro carregando imagem, tentando pr√≥xima URL‚Ä¶", urlToLoad);
        attemptIndex++;
        tryLoadNext();
      };

      imgEl.onload = function () {
        imgEl.onerror = null;
      };

      imgEl.src = urlToLoad;
    }

    tryLoadNext();
  }

  function showExerciseModal() {
    const modal = document.getElementById("exerciseModal");
    modal.classList.add("is-open");
    document.body.style.overflow = "hidden";
  }

  function closeExerciseModal() {
    const modal = document.getElementById("exerciseModal");
    modal.classList.remove("is-open");
    document.body.style.overflow = "";
  }

  document.addEventListener("DOMContentLoaded", () => {
  const modal = document.getElementById("exerciseModal");
const backdrop = modal.querySelector(".ex-modal-backdrop");
const btnClose = modal.querySelector(".ex-modal-close");
const btnPrev = modal.querySelector(".ex-nav-prev");
const btnNext = modal.querySelector(".ex-nav-next");
const btnOpen = document.getElementById("exBtnOpen");
const btnDownload = document.getElementById("exBtnDownload");


    backdrop.addEventListener("click", closeExerciseModal);
    btnClose.addEventListener("click", closeExerciseModal);

    btnPrev.addEventListener("click", () => {
      if (!modalState.images.length) return;
      modalState.currentIdx = (modalState.currentIdx - 1 + modalState.images.length) % modalState.images.length;
      updateModalImage();
    });

    btnNext.addEventListener("click", () => {
      if (!modalState.images.length) return;
      modalState.currentIdx = (modalState.currentIdx + 1) % modalState.images.length;
      updateModalImage();
    });

btnOpen.addEventListener("click", () => {
  const raw = modalState.images[modalState.currentIdx];
  if (!raw) {
    alert("Nenhum link dispon√≠vel.");
    return;
  }

  // Usa seus pr√≥prios candidatos (view, thumbnail, original)
  const candidates = buildDriveCandidates(raw);

  // Tenta abrir o primeiro candidato direto (normalmente o uc?export=view)
  const direct = candidates[0] || raw;

  window.open(direct, "_blank", "noopener");
});



    
btnDownload.addEventListener("click", () => {
  const url = modalState.images[modalState.currentIdx];

  const match = url && url.match(/\/d\/([^\/]+)\//);
  let finalUrl = url;

  if (match) {
    const fileId = match[1];
    finalUrl = `https://drive.google.com/uc?export=download&id=${fileId}`;
  }

  const a = document.createElement("a");
  a.href = finalUrl;
  a.download = "";
  document.body.appendChild(a);
  a.click();
  a.remove();
});

  });

  function setLoading(state, msg = "Carregando‚Ä¶") {
    const box = document.getElementById("global-loading");
    const bubble = box ? box.querySelector(".global-loading-bubble") : null;
    if (bubble) bubble.textContent = msg;
    document.querySelectorAll("[data-busy]").forEach(el => el.disabled = !!state);
    if (box) box.style.display = state ? "grid" : "none";
  }
</script>

<!-- Overlay global -->
<div id="global-loading" aria-live="polite" aria-busy="true" style="display:none">
  <div class="global-loading-bubble">Carregando‚Ä¶</div>
</div>

<!-- Modal de visualiza√ß√£o de exerc√≠cio -->
<div id="exerciseModal" class="ex-modal" aria-hidden="true">
  <div class="ex-modal-backdrop"></div>

  <div class="ex-modal-dialog" role="dialog" aria-modal="true">
    <button class="ex-modal-close" type="button" aria-label="Fechar">&times;</button>

    <div class="ex-modal-header">
      <div id="exModalTitle"></div>
      <div id="exModalSub"></div>
    </div>

    <div class="ex-modal-body">
      <button class="ex-nav ex-nav-prev" type="button">&#8249;</button>
      <img id="exModalImg" src="" alt="Exerc√≠cio">
      <button class="ex-nav ex-nav-next" type="button">&#8250;</button>
    </div>

    <div class="ex-modal-footer">
      <div id="exModalDesc"></div>
      <div class="ex-modal-actions">
  <button id="exBtnOpen" type="button">Abrir em nova aba</button>
  <button id="exBtnDownload" type="button">Baixar</button>
</div>

    </div>
  </div>
</div>

</body>
</html>



