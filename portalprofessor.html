<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

<title>Portal do Professor – Editora Crás</title>
<meta name="description" content="Acompanhe feedbacks, aulas gravadas e envios de exercícios.">

<!-- Favicons -->
<link rel="icon" type="image/png" href="assets/favicon.png" sizes="32x32">
<link rel="apple-touch-icon" href="assets/apple-touch-icon.png" sizes="180x180">
<link rel="shortcut icon" href="assets/favicon.ico">
<meta name="theme-color" content="#0286ff">

<!-- Open Graph -->
<meta property="og:type" content="website">
<meta property="og:site_name" content="Editora Crás">
<meta property="og:locale" content="pt_BR">
<meta property="og:title" content="Portal do Professor – Editora Crás">
<meta property="og:description" content="Acompanhe feedbacks, aulas gravadas e envios de exercícios.">

<!-- ✅ Ajuste o URL abaixo conforme a página -->
<link rel="canonical" href="http://areadosartistas.com.br/portalprofessor.html">
<meta property="og:url" content="http://areadosartistas.com.br/portalprofessor.html">

<!-- ✅ Imagem correta no GitHub Pages -->
<meta property="og:image" content="http://areadosartistas.com.br/assets/wppcompartilhar.png">
<meta property="og:image:secure_url" content="http://areadosartistas.com.br/assets/wppcompartilhar.png">
<meta property="og:image:type" content="image/png">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">

<!-- Guard: exige sessão e perfil professor (executa o quanto antes) -->
<script>
  (function enforceProfessorRole() {
    try {
      const raw = localStorage.getItem("sessao_portal");
      const sess = raw ? JSON.parse(raw) : null;

      if (!sess || !sess.email || !sess.curso) {
        alert("Faça login para acessar.");
        location.replace("index.html");
        return;
      }

      if (String(sess.perfil || "").toLowerCase() !== "professor") {
        localStorage.removeItem("sessao_portal");
        alert("Acesso de professor não validado. Faça login novamente.");
        location.replace("index.html");
        return;
      }

      if (location.search) history.replaceState({}, "", location.pathname);
    } catch (e) {
      console.error(e);
      alert("Sessão inválida. Faça login novamente.");
      localStorage.removeItem("sessao_portal");
      location.replace("index.html");
    }
  })();
</script>

<link rel="stylesheet" href="style.css?v=3">

<style>
  /* ===== correções de layout/overflow ===== */
  * { box-sizing: border-box; }
  html, body { overflow-x: hidden; }

  /* topbar sem usar 100vw para evitar “bleed” lateral */
  .topbar{
    width:auto;
    margin-left: calc(-1 * var(--gutter, 0px));
    margin-right: calc(-1 * var(--gutter, 0px));
    background:#f4c200;color:#000;font-weight:800;text-align:center;
    padding:14px 0;box-shadow:inset 0 -2px 0 rgba(0,0,0,.08);
  }

  .wrap{max-width:900px;margin:20px auto;}
  .band{max-width:900px;margin:12px auto;display:flex;flex-direction:column;gap:12px}
  .btn-band{display:block;width:100%;padding:16px 18px;border:none;border-radius:12px;
    font-weight:800;cursor:pointer;text-align:center;color:#fff}
  .btn-live{background:#ff6b6b}
  .btn-grav{background:#ff9f45}
  .panel{background:#fff;border:1px solid #f2e3a6;border-radius:18px;padding:18px;
    box-shadow:0 8px 24px rgba(0,0,0,.06)}
  .panel h3{margin:0 0 10px;text-align:center}
  .links-box a{display:block;word-break:break-all;margin:8px 0;padding:10px 12px;
    background:#f7f7ff;border-radius:10px;text-decoration:underline;color:#1d2433;text-align:center}
  .field{margin:10px auto;max-width:720px}
 .field input,
.field textarea,
.field select{
  width:100%;
  padding:12px;
  border:1px solid #cfd6e4;
  border-radius:10px;
  background:#fff;
  font-size:16px;
}
  .field textarea{min-height:110px}
  .btn-primary{display:block;width:100%;max-width:420px;margin:18px auto 6px;padding:14px 18px;
    border:none;border-radius:12px;background:#f4c200;color:#111;font-weight:800;cursor:pointer}
  .btn-neutral{display:block;width:100%;max-width:320px;margin:10px auto;padding:12px 18px;
    border:none;border-radius:12px;background:#ddd;color:#111;font-weight:800;cursor:pointer}
  .btn-exit{display:block;width:140px;margin:18px auto 0;padding:12px 18px;border:none;
    border-radius:12px;background:#d64545;color:#fff;font-weight:800;cursor:pointer}
  .hidden{display:none !important}
  .next-live, .gravada-info{ text-align:center; margin:8px 0 14px; }
  .next-live strong, .gravada-info strong{ font-weight:800; }
  .live-link{ display:inline-block; margin-top:4px; text-decoration:underline; }
  .is-invalid{
    border-color:#d64545 !important;
    box-shadow:0 0 0 2px rgba(214,69,69,.12);
    outline: none;
  }

  /* ====== TABELA (somente leitura) ====== */
  .table-wrap{
    overflow-x:auto;
    overflow-y:visible;
    -webkit-overflow-scrolling:touch;
    max-width:100%;
    border:1px solid #eee;
    border-radius:12px;
  }
  #exTable{
    border-collapse:collapse;
    table-layout:auto;
    width:max-content;
    min-width:760px;
  }
  #exTable th, #exTable td { border-bottom:1px solid #eee; padding:10px; text-align:left; font-size:14px; vertical-align:top; }
  #exTable th { position:sticky; top:0; background:#fff; z-index:1; }
  #exTable a { word-break:break-all }

  .cell-clip{
    display:block;
    max-width: 280px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  @media (min-width: 900px){
    .cell-clip{ max-width: 420px; }
  }
  td .cell-clip a{
    display:inline-block; max-width:100%;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }

  .preview-pop{
    position: fixed;
    z-index: 9999;
    max-width: min(80vw, 640px);
    background: #f7f9ff;
    border: 1px solid #cfd6e4;
    padding: 10px 12px;
    border-radius: 10px;
    box-shadow: 0 8px 24px rgba(0,0,0,.15);
    font-size: 14px;
    line-height: 1.35;
    color:#111;
  }

  .controls-bottom{
    display:flex; flex-direction:column; align-items:center; gap:6px;
    margin-top:14px;
  }
  .btn-refresh{
    display:inline-block; padding:14px 22px; border:none; border-radius:12px;
    background:#ddd; color:#111; font-weight:800; cursor:pointer; width:min(320px, 90%);
  }
  .small-muted{color:#555;font-size:14px}

  #global-loading {
    position: fixed;
    inset: 0;
    display: none;
    place-items: center;
    z-index: 2147483647;
    background: rgba(0,0,0,0.45);
    backdrop-filter: blur(8px) saturate(120%);
    -webkit-backdrop-filter: blur(8px) saturate(120%);
    will-change: backdrop-filter;
  }
  .global-loading-bubble {
    background: #fff;
    padding: 16px 22px;
    border-radius: 12px;
    font-weight: 700;
    font-size: 18px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.20);
  }

  .band + .gravada-info { margin-top: 6px; }

  #prof-exercicios { margin-left:auto; margin-right:auto; }
  #prof-exercicios .table-wrap { margin: 0 auto; max-width: 100%; }

  @media (max-width:480px){
    .wrap{ margin:16px auto; }
    .panel{ padding:14px; }
    .btn-band{ padding:14px 12px; font-size:15px; }
    .cell-clip{ max-width:180px; }
  }

  /* ===== Modal de visualização de exercício ===== */
.ex-modal {
  position: fixed;
  inset: 0;
  z-index: 10000;
  display: none;
  align-items: center;
  justify-content: center;
}

.ex-modal.is-open {
  display: flex;
}

.ex-modal-backdrop {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.65);
}

.ex-modal-dialog {
  position: relative;
  max-width: min(900px, 92vw);
  max-height: 92vh;
  background: #fff;
  border-radius: 18px;
  box-shadow: 0 14px 36px rgba(0,0,0,0.35);
  padding: 18px 22px 16px;
  display: flex;
  flex-direction: column;
  overflow: auto;
  z-index: 1;
}

.ex-modal-close {
  position: absolute;
  top: 10px;
  right: 14px;
  border: none;
  background: transparent;
  font-size: 24px;
  cursor: pointer;
}

.ex-modal-header { margin-bottom: 12px; }
#exModalTitle { font-size: 18px; font-weight: 700; }
#exModalSub { font-size: 14px; color:#555; }

.ex-modal-body {
  position: relative;
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}

#exModalImg {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
}

.ex-nav {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  border: none;
  background: rgba(0,0,0,0.35);
  color: #fff;
  width: 38px;
  height: 48px;
  border-radius: 24px;
  cursor: pointer;
  font-size: 26px;
}

.ex-nav-prev { left: 8px; }
.ex-nav-next { right: 8px; }

.ex-modal-footer {
  margin-top: 10px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

#exModalDesc { font-size: 14px; line-height: 1.4; }

.ex-modal-actions {
  display: flex;
  justify-content: center;
  gap: 12px;
}

.ex-modal-actions button {
  border: none;
  padding: 8px 18px;
  border-radius: 999px;
  font-weight: 600;
  cursor: pointer;
}

#exBtnDownload { background:#111; color:#fff; }
#exBtnCopy { background:#f4c200; color:#111; }

/* Botão "Envio 1/2/3" */
.ex-link-btn {
  background:none;
  border:none;
  padding:0;
  color:#0066cc;
  text-decoration:underline;
  cursor:pointer;
  font:inherit;
}

/* MOBILE */
@media (max-width: 600px) {
  .ex-modal-dialog {
    width: 100%;
    max-width: 100%;
    padding: 14px 12px;
    border-radius: 12px;
  }
  .ex-modal-body {
    max-height: 60vh;
  }
}

  
</style>
</head>
<body>

<div class="topbar" id="topbar">[professor]</div>

<main class="page-center" style="--center-offset:-40px;">
  <div class="wrap">

    <!-- HOME -->
    <section id="home">

      <h2 style="text-align:center;margin:8px 0 6px">Área do professor</h2>
      <br><br>

      <p id="nextLive" class="next-live hidden">
        <strong>Próximo evento ao vivo:</strong><br>
        <span id="nextLiveText">—</span><br>
        <a id="nextLiveHref" href="#" target="_blank" rel="noopener" class="live-link hidden"></a>
      </p>

      <div class="band">
        <button class="btn-band btn-live" id="btnAbrirLive" data-busy>Atualizar próxima aula ao vivo</button>
        <button class="btn-band btn-grav" id="btnAbrirGrav" data-busy>Atualizar link do feedback gravado</button>
      </div>
      
      <p id="gravadaInfo" class="gravada-info hidden">
        <strong>Aula gravada:</strong>
        <a id="gravadaHref" href="#" target="_blank" rel="noopener"></a>
      </p>

      <!-- Exercícios enviados (somente leitura) -->
      <section id="prof-exercicios" class="panel" style="max-width:1100px">
        <h3 style="margin-top:0">Exercícios para feedback:</h3>

        <div class="table-wrap">
          <table id="exTable">
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="controls-bottom">
          <button id="exAtualizar" class="btn-refresh" type="button" data-busy>Atualizar</button>
          <div class="small-muted" id="exTotalText">Total 0 exercícios</div>
        </div>
      </section>

      <br>

      <section class="panel" id="linksPanel">
        <h3>Links Úteis:</h3>
        <div class="links-box">
          <a href="https://drive.google.com/drive/folders/1WLXyVj5PXzm1ZOaCjWLvUctu_aoYohUV"
             target="_blank" rel="noopener">Pasta Central do Drive</a>
          <a href="https://chat.whatsapp.com/E8ruCXpqoK5122AWBGowwp"
             target="_blank" rel="noopener">Grupo dos alunos no Whatsapp</a>
          <a href="https://areadosartistas.com.br/faq.html"
             target="_blank" rel="noopener">FAQ da plataforma</a>
        </div>
      </section>

      <button id="btnSair" class="btn-exit" data-busy>Sair</button>
    </section>

    <!-- FORM: Próxima aula ao vivo -->
    <section id="formLive" class="panel hidden">
      <h3>Próxima aula ao vivo</h3>
      <div class="field"><input   id="fLink"  placeholder="Link"></div>
      <div class="field"><input   id="fSenha" placeholder="Senha"></div>
<div class="field">
  <select id="fHora">
    <option value="">Selecione o horário</option>
    <!-- opções serão preenchidas via JS -->
  </select>
</div>

<div class="field">
  <select id="fDia">
    <option value="">Selecione o dia</option>
    <option value="segunda-feira">Segunda-feira</option>
    <option value="terça-feira">Terça-feira</option>
    <option value="quarta-feira">Quarta-feira</option>
    <option value="quinta-feira">Quinta-feira</option>
    <option value="sexta-feira">Sexta-feira</option>
    <option value="sábado">Sábado</option>
    <option value="domingo">Domingo</option>
  </select>
</div>

      
      <div class="field"><textarea id="fInfo"  placeholder="Info"></textarea></div>

      <button id="btnEnviarLive" class="btn-primary" data-busy>Atualizar</button>
      <p style="text-align:center;">
        Apenas atualize as informações após o evento ao vivo anterior ter sido finalizado.
      </p>
      <button id="btnVoltar1" class="btn-neutral" type="button" data-busy>Voltar</button>
    </section>

    <!-- FORM: Aula gravada -->
    <section id="formGrav" class="panel hidden">
      <h3>Atualizar link do feedback gravado</h3>
      <div class="field"><input id="fGravada" placeholder="Link do feedback gravado"></div>

      <button id="btnEnviarGrav" class="btn-primary" data-busy>Atualizar</button>
      <button id="btnVoltar2" class="btn-neutral" type="button" data-busy>Voltar</button>
    </section>

  </div>
</main>

<footer class="site-footer">
  <div class="footer-inner">
    <strong>Editora Crás • </strong>
    <a href="mailto:contato@editoracras.com">Suporte</a>
    <small>© 2025. Todos os direitos reservados.</small>
  </div>
</footer>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbwQ9utyV79uWjpVHuBRWbie_2kkgTX-lPBudob49WA2daqn5qdbdqyzhl3LqYC0y_fVuQ/exec";

  const qs  = s => document.querySelector(s);
  const show = el => el.classList.remove('hidden');
  const hide = el => el.classList.add('hidden');

  let sessao = null, bootstrap = null;
let exercisesData = [];
let modalState = {
  rowIndex: null,
  images: [],
  currentIdx: 0
};

  function validEmail(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v); }

  function isValidURL(url){
    try{ const u = new URL(url); return u.protocol === 'http:' || u.protocol === 'https:'; }
    catch{ return false; }
  }
 
  function markInvalid(el, state=true){ if (!el) return; el.classList.toggle('is-invalid', !!state); }
function clearInvalidOnInput(sel){
  const el = qs(sel); if (!el) return;
  el.addEventListener('input', ()=> markInvalid(el,false));
  el.addEventListener('blur',  ()=> markInvalid(el,false));
  el.addEventListener('change',()=> markInvalid(el,false));
}

  function populateHoraSelect(){
  const sel = qs('#fHora');
  if (!sel) return;

  sel.innerHTML = '<option value="">Selecione o horário</option>';

  for (let h = 0; h < 24; h++){
    for (let m = 0; m < 60; m += 30){
      const hh = String(h).padStart(2, '0');
      const mm = String(m).padStart(2, '0');
      const value = `${hh}:${mm}`;
      const opt = document.createElement('option');
      opt.value = value;
      opt.textContent = value;
      sel.appendChild(opt);
    }
  }
}

function validateLiveForm(){
  const fLink = qs('#fLink'),
        fHora = qs('#fHora'),
        fDia  = qs('#fDia');

  const link = fLink.value.trim(),
        hora = fHora.value.trim(),
        dia  = fDia.value.trim();

  [fLink, fHora, fDia].forEach(el => markInvalid(el,false));
  const errors = [];

  if (!link || !isValidURL(link)){
    errors.push('• Informe um LINK válido (http/https).');
    markInvalid(fLink,true);
  }
  if (!hora){
    errors.push('• Selecione a HORA da aula.');
    markInvalid(fHora,true);
  }
  if (!dia){
    errors.push('• Selecione o DIA da aula.');
    markInvalid(fDia,true);
  }

  if (errors.length){
    alert('Verifique os campos obrigatórios:\n\n' + errors.join('\n'));
    const firstInvalid = [fLink,fHora,fDia].find(el => el.classList.contains('is-invalid'));
    if (firstInvalid) firstInvalid.focus();
    return false;
  }
  return { link, hora, dia };
}


  function renderNextLive(src){
    const box = qs('#nextLive'), txt = qs('#nextLiveText'), a = qs('#nextLiveHref');

    const dia  = String(src?.dia || '').trim();
    const hora = String(src?.hora || '').trim();
    const prof = String(src?.professor || '').trim();
    const link = String(src?.link || '').trim();

    const parts = [];
    if (dia)  parts.push(dia);
    if (hora) parts.push(hora);

    let texto = parts.join(', ');
    if (texto && prof) texto += ' com ' + prof;

    const hasText = !!texto;
    const hasLink = !!link;

    txt.textContent = hasText ? texto : '—';

    if (hasLink){
      a.textContent = link;
      a.href = link;
      a.classList.remove('hidden');
    } else {
      a.textContent = '';
      a.removeAttribute('href');
      a.classList.add('hidden');
    }

    box.classList.toggle('hidden', !(hasText || hasLink));
  }

  function renderGravada(src){
    const p = qs('#gravadaInfo'), a = qs('#gravadaHref'), url = String(src?.aulaGravada || '').trim();
    if (url){ a.textContent = url; a.href = url; p.classList.remove('hidden'); }
    else { a.textContent = ''; a.removeAttribute('href'); p.classList.add('hidden'); }
  }

  /* ===== helpers para clip + popover ===== */
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function stripTags(html){
    const tmp = document.createElement('div');
    tmp.innerHTML = html;
    return tmp.textContent || tmp.innerText || '';
  }
  function wrapClipHTML(innerHTML){
    const fullTxt = stripTags(innerHTML);
    return `<div class="cell-clip" data-full="${escapeHtml(fullTxt)}">${innerHTML}</div>`;
  }

  /* ========= Apenas a coluna "Descrição" fica menor (colgroup dinâmico) ========= */
  function setDescricaoWidth(headers, desktopWidth = "320px", mobileWidth = "200px"){
    const table = document.getElementById("exTable");
    if (!table || !headers || !headers.length) return;

    const descIndex = headers.findIndex(h => /descr/i.test(String(h)));
    if (descIndex === -1) return;

    const old = table.querySelector("colgroup");
    if (old) old.remove();

    const isMobile = window.matchMedia("(max-width: 480px)").matches;
    const width = isMobile ? mobileWidth : desktopWidth;

    const cg = document.createElement("colgroup");
    headers.forEach((_, i) => {
      const col = document.createElement("col");
      if (i === descIndex){
        col.style.width = width;
        col.style.minWidth = width;
        col.style.maxWidth = width;
      }
      cg.appendChild(col);
    });

    table.insertBefore(cg, table.firstChild);
  }

function attachOverflowPreview(){
  const root = document.querySelector('#exTable');
  if (!root) return;   // ✅ linha nova de proteção

  let pop = null;

  function show(e){
    const clip = e.currentTarget;
    if (clip.scrollWidth <= clip.clientWidth) return;
    if (pop) pop.remove();
    pop = document.createElement('div');
    pop.className = 'preview-pop';
    pop.textContent = clip.dataset.full || clip.textContent || '';
    document.body.appendChild(pop);
    position(e);
  }
  function position(e){
    if (!pop) return;
    const pad = 8;
    let x = (e.clientX || 20) + 14;
    let y = (e.clientY || 20) + 14;
    const vw = window.innerWidth, vh = window.innerHeight;
    const r = pop.getBoundingClientRect();
    if (x + r.width  + pad > vw) x = vw - r.width  - pad;
    if (y + r.height + pad > vh) y = vh - r.height - pad;
    pop.style.left = x + 'px';
    pop.style.top  = y + 'px';
  }
  function hide(){ if (pop){ pop.remove(); pop = null; } }

  root.querySelectorAll('.cell-clip').forEach(el=>{
    el.addEventListener('mouseenter', show);
    el.addEventListener('mousemove', position);
    el.addEventListener('mouseleave', hide);
    el.addEventListener('click', show);
  });
  document.addEventListener('touchstart', () => { if (pop) { pop.remove(); pop=null; } }, {passive:true});
}




  
function attachModalTriggers() {
  document.querySelectorAll(".ex-link-btn").forEach(btn => {
    btn.addEventListener("click", e => {
      const rowIndex = parseInt(e.currentTarget.dataset.rowIndex || "0", 10);
      const imgIndex = parseInt(e.currentTarget.dataset.imgIndex || "1", 10);
      openExerciseModal(rowIndex, imgIndex);
    });
  });
}

  // ====== Exercícios – carregar tudo (sem paginação) ======
  const PAGE_SIZE = 100000;

  function isLinkCol(h){
    return /\blink/i.test(String(h || ""));
  }
  function linkLabelFromHeader(h){
    const m = String(h || "").match(/\d+/);
    return m ? `Envio ${m[0]}` : "Envio";
  }
  function renderCellHTML(header, value){
    const s = String(value || "").trim();
    if (!s) return "";
    if (isLinkCol(header) && /^https?:\/\//i.test(s)){
      const label = linkLabelFromHeader(header);
      return `<a href="${s}" target="_blank" rel="noopener">${label}</a>`;
    }
    if (/^https?:\/\//i.test(s)) return `<a href="${s}" target="_blank" rel="noopener">${s}</a>`;
    return s;
  }
  function needsClip(h){
    return /descr/i.test(String(h || ""));
  }

async function fetchExercisesPreview() {
  try {
    setLoading(true, "Carregando exercícios…");

    const params = new URLSearchParams({
      action: "listExercisesPreview",
      curso:  sessao.curso,
      email:  sessao.email,
      limit:  PAGE_SIZE,
      offset: 0
    });

    const r = await fetch(`${API_URL}?${params.toString()}`, { cache: 'no-store' });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const d = await r.json();
    if (!d.ok) throw new Error(d.message || "Falha ao listar exercícios.");

    // Cabeçalho da tabela
    const thead = document.querySelector("#exTable thead");
    thead.innerHTML = "";
    const trh = document.createElement("tr");
    (d.headers || []).forEach(h => {
      const th = document.createElement("th");
      th.textContent = h;
      trh.appendChild(th);
    });
    thead.appendChild(trh);

    // Cache de headers para o modal
    if (!bootstrap) bootstrap = {};
    bootstrap.headersCache = d.headers || [];

    setDescricaoWidth(bootstrap.headersCache);

    // Corpo da tabela
    const tbody = document.querySelector("#exTable tbody");
    tbody.innerHTML = "";

    // ✅ guarda todas as linhas para o modal
    exercisesData = d.rows || [];

    (d.rows || []).forEach((row, rowIndex) => {
      const tr = document.createElement("tr");

      (d.headers || []).forEach(h => {
        const td = document.createElement("td");
        const rawValue = row[h];
        const s = String(rawValue || "").trim();

        if (!s) {
          td.textContent = "";
          tr.appendChild(td);
          return;
        }

        if (isLinkCol(h) && /^https?:\/\//i.test(s)) {
          // coluna de link de imagem -> botão "Envio X"
          const imgIdx = parseInt((h.match(/\d+/) || ["1"])[0], 10);
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "ex-link-btn";
          btn.textContent = linkLabelFromHeader(h); // "Envio 1", "Envio 2"...
          btn.dataset.rowIndex = rowIndex;
          btn.dataset.imgIndex = imgIdx;
          td.appendChild(btn);
        } else {
          // outras colunas normais
          const html = renderCellHTML(h, rawValue);
          td.innerHTML = needsClip(h) ? wrapClipHTML(html) : html;
        }

        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    });

    // textos longos com tooltip
    attachOverflowPreview();
    // conecta cliques dos botões "Envio X" ao modal
    attachModalTriggers();

    // Total de exercícios
    const total = d.totalRows || 0;
    const label = total === 1 ? "exercício" : "exercícios";
    document.getElementById("exTotalText").textContent = `Total ${total} ${label}`;

    // Nenhum envio
    if ((d.rows || []).length === 0) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = (d.headers || []).length || 1;
      td.style.textAlign = "center";
      td.style.color = "#666";
      td.textContent = "Nenhum envio encontrado.";
      tr.appendChild(td);
      tbody.appendChild(tr);
    }

  } catch (e) {
    alert("Erro: " + e.message);
  } finally {
    setLoading(false);
  }
}


  

  document.addEventListener('DOMContentLoaded', boot);

  async function boot(){
    try { sessao = JSON.parse(localStorage.getItem('sessao_portal') || 'null'); } catch {}
    if (!sessao || !validEmail(sessao.email) || !sessao.curso) {
      alert('Faça login para acessar.');
      location.replace('index.html');
      return;
    }

    setLoading(true, "Carregando painel…");
    const resp = await fetch(`${API_URL}?action=portalBootstrap&curso=${encodeURIComponent(sessao.curso)}&email=${encodeURIComponent(sessao.email)}`, { cache:'no-store' });
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);       /* ✅ */
    bootstrap = await resp.json();
    setLoading(false);

    if (!bootstrap || bootstrap.allowed !== true || String(bootstrap.perfil).toLowerCase() !== 'professor') {
      alert('Acesso de professor não validado. Faça login novamente.');
      location.replace('index.html');
      return;
    }

    qs('#topbar').textContent = `[${bootstrap.nome || 'professor'}]`;

    if (bootstrap?.feedback){
      renderNextLive(bootstrap.feedback);
      renderGravada(bootstrap.feedback);
    }
populateHoraSelect();

    qs('#btnAbrirLive').addEventListener('click', () => { hide(qs('#home')); show(qs('#formLive')); window.scrollTo({top:0,behavior:'smooth'}); });
    qs('#btnAbrirGrav').addEventListener('click', () => { hide(qs('#home')); show(qs('#formGrav')); window.scrollTo({top:0,behavior:'smooth'}); });
    qs('#btnVoltar1').addEventListener('click', goHome);
    qs('#btnVoltar2').addEventListener('click', goHome);
    qs('#btnSair').addEventListener('click', () => { localStorage.removeItem('sessao_portal'); location.replace('index.html'); });

    qs('#btnEnviarLive').addEventListener('click', enviarLive);
    qs('#btnEnviarGrav').addEventListener('click', enviarGrav);

    document.getElementById("exAtualizar").addEventListener("click", fetchExercisesPreview);

    fetchExercisesPreview();

    window.addEventListener("resize", () => setDescricaoWidth( (bootstrap?.headersCache || []) ));

    ['#fLink','#fHora','#fDia'].forEach(clearInvalidOnInput);
  }

  function clearForms(){
    ['#fLink','#fSenha','#fHora','#fDia','#fInfo','#fGravada'].forEach(sel=>{
      const el = qs(sel); if (el) { el.value = ''; markInvalid(el,false); }
    });
  }

  function goHome(){
    hide(qs('#formLive')); hide(qs('#formGrav'));
    show(qs('#home'));
    clearForms();
    history.replaceState({}, "", location.pathname);
    window.scrollTo({top:0,behavior:'smooth'});
  }

  async function enviarLive(){
    const ok = validateLiveForm();
    if (!ok) return;

    const body = new URLSearchParams({
      action: 'updateFeedbackLive',
      curso:  sessao.curso,
      email:  sessao.email,
      link:   qs('#fLink').value.trim(),
      senha:  qs('#fSenha').value.trim(),
      hora:   qs('#fHora').value.trim(),
      dia:    qs('#fDia').value.trim(),
      info:   qs('#fInfo').value.trim()
    });

    setLoading(true, "Atualizando informações…");
    try{
      const r = await fetch(API_URL, { method:'POST', body });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);            /* ✅ */
      const data = await r.json();
      if (!data || data.ok !== true) throw new Error((data && (data.message || data.error)) || 'Falha ao atualizar');

      renderNextLive({
        dia:  qs('#fDia').value.trim(),
        hora: qs('#fHora').value.trim(),
        professor: bootstrap?.nome || '',
        link: qs('#fLink').value.trim()
      });

      goHome();
      setTimeout(()=>alert('Próxima aula ao vivo atualizada!'), 50);
    }catch(e){
      alert('Erro ao atualizar: ' + e.message);
    }finally{
      setLoading(false);
    }
  }

  async function enviarGrav(){
    const body = new URLSearchParams({
      action: 'updateGravada',
      curso:  sessao.curso,
      email:  sessao.email,
      aulaGravada: qs('#fGravada').value.trim()
    });

    setLoading(true, "Atualizando aula gravada…");
    try{
      const r = await fetch(API_URL, { method:'POST', body });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);            /* ✅ */
      const data = await r.json();
      if (!data || data.ok !== true) throw new Error((data && (data.message || data.error)) || 'Falha ao atualizar');

      renderGravada({ aulaGravada: qs('#fGravada').value.trim() });
      goHome();
      setTimeout(()=>alert('Link da aula gravada atualizado!'), 50);
    }catch(e){
      alert('Erro ao atualizar: ' + e.message);
    }finally{
      setLoading(false);
    }
  }
function buildImagesArrayForRow(row) {
  const images = [];
  (bootstrap?.headersCache || []).forEach(h => {
    if (isLinkCol(h)) {
      const url = row[h];
      if (url) images.push(url);
    }
  });
  return images;
}

function openExerciseModal(rowIndex, imgIndexFrom1) {
  const row = exercisesData[rowIndex];
  if (!row) return;

  modalState.rowIndex = rowIndex;
  modalState.images = buildImagesArrayForRow(row);
  modalState.currentIdx = (imgIndexFrom1 - 1) || 0;

  const nome   = row["Nome"] || "";
  const modulo = row["Módulo"] || row["Modulo"] || "";
  const aula   = row["Aula"] || "";
  const desc   = row["Descrição"] || row["Descricao"] || "";

  document.getElementById("exModalTitle").textContent = nome;
  document.getElementById("exModalSub").textContent = [modulo, aula].filter(Boolean).join(" - ");
  document.getElementById("exModalDesc").textContent = desc;

  updateModalImage();
  showExerciseModal();
}



// NOVO – gera uma URL "direta" de imagem a partir do link do Drive
function getDriveViewUrl(url) {
  try {
    if (!url) return "";

    // Se já for uma URL "direta" do Google (googleusercontent), usa como está
    if (url.includes("googleusercontent.com")) {
      return url;
    }

    // Só tratamos links do Drive
    if (url.includes("drive.google.com")) {
      const u = new URL(url);

      // Formato padrão: https://drive.google.com/file/d/ARQUIVO_ID/...
      const parts = u.pathname.split("/");
      const dIndex = parts.indexOf("d");
      let fileId = null;

      if (dIndex !== -1 && parts[dIndex + 1]) {
        fileId = parts[dIndex + 1];
      }

      // Outro formato: https://drive.google.com/open?id=ARQUIVO_ID
      if (!fileId) {
        const idParam = u.searchParams.get("id");
        if (idParam) fileId = idParam;
      }

      // Se achou o ID, monta uma URL direta de download/visualização
      if (fileId) {
        // `export=download` costuma funcionar melhor como imagem também
        return `https://drive.google.com/uc?export=download&id=${fileId}`;
      }
    }

    // Se não for Drive (ou der erro), devolve a URL original
    return url;
  } catch (e) {
    return url;
  }
}



  

function updateModalImage() {
  const imgEl = document.getElementById("exModalImg");
  const rawUrl = modalState.images[modalState.currentIdx];
  imgEl.src = getDriveViewUrl(rawUrl);
}



function showExerciseModal() {
  const modal = document.getElementById("exerciseModal");
  modal.classList.add("is-open");
  document.body.style.overflow = "hidden";
}

function closeExerciseModal() {
  const modal = document.getElementById("exerciseModal");
  modal.classList.remove("is-open");
  document.body.style.overflow = "";
}

document.addEventListener("DOMContentLoaded", () => {
  const modal = document.getElementById("exerciseModal");
  const backdrop = modal.querySelector(".ex-modal-backdrop");
  const btnClose = modal.querySelector(".ex-modal-close");
  const btnPrev = modal.querySelector(".ex-nav-prev");
  const btnNext = modal.querySelector(".ex-nav-next");
  const btnDownload = document.getElementById("exBtnDownload");
  const btnCopy = document.getElementById("exBtnCopy");

  backdrop.addEventListener("click", closeExerciseModal);
  btnClose.addEventListener("click", closeExerciseModal);

  btnPrev.addEventListener("click", () => {
    modalState.currentIdx = (modalState.currentIdx - 1 + modalState.images.length) % modalState.images.length;
    updateModalImage();
  });

  btnNext.addEventListener("click", () => {
    modalState.currentIdx = (modalState.currentIdx + 1) % modalState.images.length;
    updateModalImage();
  });

btnDownload.addEventListener("click", () => {
  const url = modalState.images[modalState.currentIdx];

  // tenta extrair o ID do arquivo do Drive
  const match = url && url.match(/\/d\/([^\/]+)\//);
  let finalUrl = url;

  if (match) {
    const fileId = match[1];
    // URL própria para download direto
    finalUrl = `https://drive.google.com/uc?export=download&id=${fileId}`;
  }

  const a = document.createElement("a");
  a.href = finalUrl;
  a.download = "";
  document.body.appendChild(a);
  a.click();
  a.remove();
});


btnCopy.addEventListener("click", async () => {
  const rawUrl = modalState.images[modalState.currentIdx];
  const url = getDriveViewUrl(rawUrl); // URL direta da imagem

  // Verifica se o navegador suporta copiar IMAGEM
  if (!navigator.clipboard || !window.ClipboardItem) {
    alert("Seu navegador não permite copiar a imagem automaticamente. Use o botão Baixar.");
    return;
  }

  try {
    // Tenta baixar a imagem
    const res = await fetch(url);
    const blob = await res.blob();

    const item = new ClipboardItem({ [blob.type]: blob });
    await navigator.clipboard.write([item]);

    alert("Imagem copiada! Agora é só colar com Ctrl+V no seu programa de desenho.");
  } catch (e) {
    console.error(e);
    alert("Não foi possível copiar a imagem automaticamente. Use o botão Baixar.");
  }
});



});

  
</script>

<script>
  function setLoading(state, msg = "Carregando…") {
    const box = document.getElementById("global-loading");
    const bubble = box ? box.querySelector(".global-loading-bubble") : null;
    if (bubble) bubble.textContent = msg;
    document.querySelectorAll("[data-busy]").forEach(el => el.disabled = !!state);
    if (box) box.style.display = state ? "grid" : "none";
  }
</script>

<!-- Overlay global -->
<div id="global-loading" aria-live="polite" aria-busy="true" style="display:none">
  <div class="global-loading-bubble">Carregando…</div>
</div>
<!-- Modal de visualização de exercício -->
<div id="exerciseModal" class="ex-modal" aria-hidden="true">
  <div class="ex-modal-backdrop"></div>

  <div class="ex-modal-dialog" role="dialog" aria-modal="true">
    <button class="ex-modal-close" type="button" aria-label="Fechar">&times;</button>

    <div class="ex-modal-header">
      <div id="exModalTitle"></div>
      <div id="exModalSub"></div>
    </div>

    <div class="ex-modal-body">
      <button class="ex-nav ex-nav-prev" type="button">&#8249;</button>
      <img id="exModalImg" src="" alt="Exercício">
      <button class="ex-nav ex-nav-next" type="button">&#8250;</button>
    </div>

    <div class="ex-modal-footer">
      <div id="exModalDesc"></div>
      <div class="ex-modal-actions">
        <button id="exBtnDownload" type="button">Baixar</button>
        <button id="exBtnCopy" type="button">Copiar</button>
      </div>
    </div>
  </div>
</div>

  
</body>
</html>






