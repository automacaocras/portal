<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

  <title>Portal do Aluno ‚Äì Editora Cr√°s</title>
  <meta name="description" content="Acompanhe feedbacks, aulas gravadas e envios de exerc√≠cios.">

  <!-- Favicons -->
  <link rel="icon" type="image/png" href="assets/favicon.png" sizes="32x32">
  <link rel="apple-touch-icon" href="assets/apple-touch-icon.png" sizes="180x180">
  <link rel="shortcut icon" href="assets/favicon.ico">
  <meta name="theme-color" content="#0286ff">

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="Editora Cr√°s">
  <meta property="og:locale" content="pt_BR">
  <meta property="og:title" content="Portal do Aluno ‚Äì Editora Cr√°s">
  <meta property="og:description" content="Acompanhe feedbacks, aulas gravadas e envios de exerc√≠cios.">

  <!-- ‚úÖ Ajuste o URL abaixo conforme a p√°gina -->
  <link rel="canonical" href="http://areadosartistas.com.br/portalaluno.html">
  <meta property="og:url" content="http://areadosartistas.com.br/portalaluno.html">

  <!-- ‚úÖ Imagem correta -->
  <meta property="og:image" content="http://areadosartistas.com.br/assets/wppcompartilhar.png">
  <meta property="og:image:secure_url" content="http://areadosartistas.com.br/assets/wppcompartilhar.png">
  <meta property="og:image:type" content="image/png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">

  <!-- Guard: exige sess√£o e perfil aluno -->
  <script>
    (function enforceAlunoRole() {
      try {
        const raw = localStorage.getItem("sessao_portal");
        const sess = raw ? JSON.parse(raw) : null;

        if (!sess || !sess.email || !sess.curso) {
          alert("Fa√ßa login para acessar.");
          location.replace("index.html");
          return;
        }

        if (String(sess.perfil || "").toLowerCase() !== "aluno") {
          localStorage.removeItem("sessao_portal");
          alert("Acesso de aluno n√£o validado. Fa√ßa login novamente.");
          location.replace("index.html");
          return;
        }

        if (location.search) history.replaceState({}, "", location.pathname);
      } catch (e) {
        console.error(e);
        alert("Sess√£o inv√°lida. Fa√ßa login novamente.");
        localStorage.removeItem("sessao_portal");
        location.replace("index.html");
      }
    })();
  </script>

  <link rel="stylesheet" href="style.css?v=7">
<style>
  .topbar{
    width:100vw;
    margin-left:calc(50% - 50vw);
    margin-right:calc(50% - 50vw);
    background:#e6b200;
    color:#000;
    font-weight:800;
    text-align:center;
    padding:12px 0;
    box-shadow:inset 0 -2px 0 rgba(0,0,0,.08)
  }
  .curso-logo{width:200px;max-width:60vw;height:auto;display:block;margin:10px auto 6px}
  .dias-restantes{font-weight:800;margin:8px 0 6px;text-align:center}
  .dias-danger{color:#d93025}

  .card,.box-feedback{
    max-width:900px;
    margin:14px auto;
    background:#fff;
    border:1px solid #f2e3a6;
    border-radius:18px;
    padding:18px;
    box-shadow:0 8px 24px rgba(0,0,0,.06);
    text-align:center
  }

  label{display:block;text-align:left;font-weight:700;margin-top:10px;margin-bottom:4px}
  select,textarea,input[type="file"]{width:100%;max-width:100%;box-sizing:border-box}
  textarea{min-height:120px;border-radius:10px;border:1px solid #ccc;padding:10px}

  .btn-cta{
    display:block;
    width:100%;
    max-width:900px;
    margin:16px auto 10px;
    padding:16px 18px;
    border:none;
    border-radius:18px;
    background:#e6b200;
    color:#111;
    font-weight:800;
    cursor:pointer
  }

  .flex-row{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}
  .btn-sec{background:#ddd;color:#111;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn-exit{display:inline-block;margin:8px auto 24px;padding:10px 18px;background:#e53935;color:#fff;border:none;border-radius:12px;font-weight:800;cursor:pointer}
  .btn-back{background:#ddd;color:#111;border:none;border-radius:12px;padding:10px 18px;font-weight:800;cursor:pointer}
  .hidden{display:none!important}

  select{
    appearance:none;-webkit-appearance:none;-moz-appearance:none;
    background:#fff url('data:image/svg+xml;utf8,<svg fill="%23000" height="20" width="20" xmlns="http://www.w3.org/2000/svg"><polygon points="5,8 10,13 15,8"/></svg>') no-repeat right 12px center;
    background-size:12px;
    border:1px solid #ccc;
    border-radius:10px;
    padding:10px 36px 10px 12px;
    font-size:16px;
    font-weight:600;
    color:#222;
    cursor:pointer;
    transition:border-color .2s
  }
  select:hover{border-color:#999}
  select:disabled{background-color:#f8f8f8;color:#888}

  .envio-arts-info{
    max-width:900px;
    margin:10px auto 0;
    text-align:center;
    font-weight:800;
    font-size:14.5px;
    color:#222
  }

  .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.45);z-index:9999}
  .modal.show{display:grid}
  .modal-card{width:min(480px,92vw);background:#fff;border-radius:14px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.2)}
  .modal-card h3{margin:0 0 10px;text-align:center}

  .input-tel{width:100%;padding:12px;border:1px solid #cfd6e4;border-radius:10px;font-size:16px}
  .modal-actions{display:flex;gap:10px;justify-content:center;margin-top:12px}
  .modal-actions button{padding:10px 16px;border:none;border-radius:10px;font-weight:800;cursor:pointer}
  .btn-primary{background:#e6b200;color:#111}
  .btn-neutral{background:#ddd;color:#111}
  .small-hint{font-size:12px;color:#666;text-align:center;margin-top:6px}

/* ===== MODAL (EVOLU√á√ÉO) ‚Äî n√£o estoura a tela ===== */
#evImgModal .modal-card{
  display:flex;
  flex-direction:column;
  max-height:calc(100vh - 40px);   /* PC */
  overflow:hidden;                /* impede a imagem de "vazar" */
}

#evImgModal .ev-modal-body{
  overflow:auto;                  /* scroll dentro do card */
  -webkit-overflow-scrolling: touch;
  padding:0 0 12px;
}

#evImgModal #evModalImg{
  width:100%;
  height:auto;
  max-height:calc(100vh - 220px);  /* reserva espa√ßo p/ t√≠tulo + bot√µes */
  object-fit:contain;
  display:block;
  border-radius:12px;
}

@media (max-width: 520px){
  /* card ocupa quase a tela toda, mas com respiro */
  #evImgModal .modal-card{
    max-height:calc(100vh - 64px);
    padding:12px;
  }

  /* √°rea rol√°vel mais compacta */
  #evImgModal .ev-modal-body{
    padding-bottom:8px;
  }

  /* imagem bem mais contida */
  #evImgModal #evModalImg{
    max-height:calc(100vh - 280px); /* üëà chave do ajuste */
    object-fit:contain;
  }

  /* bot√µes n√£o ‚Äúroubam‚Äù altura */
  #evImgModal .modal-actions{
    gap:8px;
  }

  #evImgModal .modal-actions button{
    padding:10px 12px;
    font-size:14px;
  }
}


  
  .topbar-phone{font-weight:600;font-size:14px;margin-left:6px}
  .topbar-phone a{color:#000;text-decoration:underline;cursor:pointer}

  .live-badge{display:none;width:max-content;margin:0 auto 10px;padding:6px 14px;background:#c9f96a;color:#1a1a1a;border-radius:8px;font-weight:800}
  .box-feedback.is-live{box-shadow:0 0 0 3px rgba(114,210,0,.25), 0 8px 24px rgba(0,0,0,.06)}

  /* ===== badges ===== */
  .ev-badge{
    display:inline-block;
    padding:6px 10px;
    border-radius:10px;
    font-weight:800;
    font-size:12px;
  }
  .ev-green{ background:#28a745; color:#fff; }
  .ev-orange{ background:#f4a300; color:#111; }

#evolucao #evSuccessMsg{
  max-width:900px;
  margin:10px auto 0;
}
.sucesso-msg{
  background-color:#e6f7e1;
  padding:16px;
  border-radius:12px;
  text-align:center;
  box-shadow:0 4px 12px rgba(0,0,0,0.08);
  border:1px solid rgba(40,167,69,.25);
}


  /* =========================================================
     EVOLU√á√ÉO ‚Äî SEM ‚ÄúCARD BRANCO POR TR√ÅS‚Äù (APENAS ETAPAS)
     ========================================================= */

  /* wrapper da se√ß√£o (n√£o √© card) */
  #evolucao .ev-root{
    max-width:900px;
    margin:14px auto;
    padding:0;
    background:transparent;
    border:none;
    box-shadow:none;
    text-align:center; /* t√≠tulo centralizado */
  }

  /* container da lista de etapas ocupa 100% */
  #evolucao #evThumbsWrap{
    width:100%;
  }

  /* coluna de etapas */
  #evolucao .ev-thumbs{
    width:100%;
    display:flex;
    flex-direction:column;
    gap:14px;
    align-items:stretch;
    margin-top:12px;
  }

  /* cada etapa √© o ‚Äúcard grande‚Äù */
  #evolucao .ev-block{
    width:100%;
    background:#fff;
    border:1px solid #f2e3a6;
    border-radius:18px;
    padding:16px;
    box-shadow:0 8px 24px rgba(0,0,0,.06);
    text-align:left;
  }

  #evolucao .ev-stage-title{
    margin:0 0 10px;
    font-weight:900;
    padding:10px 12px;
    border-radius:10px;
    background:#f7f2dc;
    border:1px solid #f2e3a6;
  }

  #evolucao .ev-stage-grid{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    justify-content:flex-start;
  }

  #evolucao .ev-thumb{
    width:110px;
    height:110px;
    object-fit:cover;
    border-radius:12px;
    border:1px solid #eee;
    cursor:pointer;
    box-shadow:0 6px 16px rgba(0,0,0,.08);
  }
  #evolucao .ev-thumb:hover{ transform: translateY(-1px); }

  #evolucao .ev-stage-banner{
    display:flex;
    gap:10px;
    align-items:center;
    margin:10px 0 10px;
    font-weight:800;
    font-size:14px;
  }

  #evolucao .ev-files{
    display:flex;
    flex-direction:column;
    gap:10px;
    margin-top:10px;
  }
  #evolucao .ev-files input[type="file"]{
    width:100%;
  }

/* ===== Coment√°rio do professor (EVOLU√á√ÉO) ===== */
#evolucao .ev-prof-wrap{
  margin-top:18px;            /* ‚úÖ mais dist√¢ncia acima do bloco */
}

#evolucao .ev-prof-title{
  margin:0 0 6px;             /* ‚úÖ pouco espa√ßo embaixo do t√≠tulo */
  font-weight:800;
}

#evolucao .ev-prof-text{
  margin:0;                   /* ‚úÖ remove o ‚Äúburaco‚Äù padr√£o do <p> */
  font-size:14px;             /* ‚úÖ menor */
  line-height:1.35;           /* ‚úÖ mais compacto */
  color:#111;
  white-space:pre-wrap;       /* mant√©m quebras de linha do .txt */
  word-break:break-word;      /* evita estourar no celular */
}

#evolucao .ev-prof-date{
  margin:6px 0 0;             /* ‚úÖ data bem perto do texto */
  font-size:12px;             /* ‚úÖ menor */
  font-weight:700;
  color:#444;
}


  
/* ===== Autoriza√ß√£o (checkbox) ‚Äî EVOLU√á√ÉO ===== */
#evolucao #evAuthWrap{
  margin-top:18px;
  text-align:left;
}
#evolucao .thumb-hint{
  margin-bottom:12px;
}
#evolucao .ev-auth-label{
  display:flex;
  align-items:center;           /* alinha texto com a caixa */
  gap:10px;
  font-weight:600;              /* menos pesado */
  line-height:1.3;
  cursor:pointer;
  user-select:none;
}

#evolucao .ev-auth-label input[type="checkbox"]{
  width:18px;
  height:18px;
  margin:0;
  flex:0 0 18px;
  accent-color:#111;
}


#evolucao .ev-auth-text{
  font-size:14px;               /* tamanho correto */
  color:#111;
}

/* estado de erro (texto vermelho) */
#evolucao .ev-auth-text.is-error{
  color:#d93025;
}
/* ===== Mensagem final ‚Äì Evolu√ß√£o conclu√≠da ===== */
#evolucao #evDoneMsg{
  max-width:900px;
  margin:20px auto 12px;
}

#evolucao .ev-done-box{
  background:#e6f7e1;
  border:1px solid rgba(40,167,69,.3);
  color:#1e7e34;
  padding:16px;
  border-radius:14px;
  text-align:center;
  font-weight:700;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
}
/* ===== EVOLU√á√ÉO: thumbs menores no celular (evita quebrar 3¬™ imagem) ===== */
@media (max-width: 520px){
  #evolucao .ev-stage-grid{
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap:8px;
  }

  #evolucao .ev-thumb{
    width:100%;
    height:auto;
    aspect-ratio: 1 / 1;
  }
}

.ev-final-actions{
  display:flex;
  gap:12px;
  justify-content:center;
}
.ev-final-actions .btn-cta{
  margin:0;
  max-width:420px;
}
  


</style>

 
</head>
<body>

  <div class="topbar">[aluno]</div>

  <main class="page-center" style="--center-offset:-40px;">
    <img id="cursoLogo" class="curso-logo" alt="Curso" style="display:none">
    <div id="diasRestantes" class="dias-restantes">Carregando...</div>

    <!-- Cupom -->
    <div id="cupomBox" class="card" style="display:none">
      <div data-nome>{NOME}, seu acesso ao curso est√° acabando üò¢</div>
      <div style="margin-top:6px">
        Use o cupom <span id="cupomCod" style="background:#111;color:#ffd400;padding:3px 8px;border-radius:6px;font-weight:800">---</span>
        e receba <strong id="cupomPerc">---</strong>% de desconto para continuar.
        <a id="cupomLink" href="#" target="_blank" rel="noopener">Clique aqui</a>.
      </div>
    </div>

    <!-- DASHBOARD -->
    <section id="dashboard">
      <div class="box-feedback">
        <div id="liveBadge" class="live-badge">Estamos ao vivo!</div>
        <h3 id="fbTitulo">Pr√≥ximo evento ao vivo:</h3>
        <p><strong id="fbDiaTxt" style="display:none"></strong><strong id="fbHoraTxt" style="display:none"></strong></p>
        <p>Professor: <strong id="fbProf">‚Äî</strong></p>
        <p><a id="fbLink" href="#" target="_blank" rel="noopener" style="display:none">[link da aula]</a></p>
        <p>Senha: <strong id="fbSenha">‚Äî</strong></p>
        <p id="fbInfo" style="margin-top:10px;color:#333"></p>
      </div>

      <button id="btnAbrirEnvio" class="btn-cta" type="button" data-busy>Envie os exerc√≠cios para feedback</button>
      <p id="prazoEnvioNote" style="text-align:center;color:#333;margin:6px 0 0; display:none;"></p>

      <div id="gravadaCard" class="card" style="display:none">
        <h3>√öltima aula gravada:</h3>
        <p class="hint">Esse link pode expirar.</p>
        <p><a id="ultimaGravada" href="#" target="_blank" rel="noopener">[link]</a></p>
      </div>

<button id="btnEvolucao" class="btn-cta" type="button" style="display:none;">

  Minha evolu√ß√£o
</button>

      
      <div class="links-uteis" style="text-align:center; margin-top:25px;">
        <strong>Links √öteis:</strong><br>
        <a href="https://chat.whatsapp.com/E8ruCXpqoK5122AWBGowwp?mode=wwt" target="_blank" rel="noopener noreferrer" style="display:inline-block; margin-top:8px; color:#075e54; font-weight:600; text-decoration:none;">üí¨ Grupo dos alunos no WhatsApp</a>
        <br>
        <a href="https://discord.gg/Fjxw7kYMfk" target="_blank" rel="noopener noreferrer" style="display:inline-block; margin-top:8px; color:#5A0E71; font-weight:600; text-decoration:none;">üé® Servidor dos alunos no Discord</a><br>
 <a href="https://areadosartistas.com.br/faq.html" target="_blank" rel="noopener noreferrer" style="display:inline-block; margin-top:8px; color:#5A0E71; font-weight:600; text-decoration:none;">FAQ | D√∫vidas sobre a plataforma</a>
      </div>

      <br>
      <div style="text-align:center"><button id="btnSair" class="btn-exit" type="button" data-busy>Sair</button></div>
      <p style="font-size:11px; text-align:center; color:#666; margin-top:0px;">
        <em data-nome>{NOME}, nunca compartilhe seu acesso com outras pessoas. Sua conta pode ser suspensa.</em>
      </p>
    </section>

<!-- EVOLU√á√ÉO -->
<section id="evolucao" class="hidden">
  <div class="ev-root">
    <h2 id="evTitle">Minha evolu√ß√£o</h2>
    <p id="evSubtitle" class="hint" style="margin-top:6px;"></p>

<!-- ‚úÖ MENSAGEM FINAL (S√ì QUANDO CONCLU√çDO) -->
<div id="evDoneMsg" class="hidden">
  <div class="ev-done-box">
    <strong>Voc√™ teve uma evolu√ß√£o incr√≠vel, <span data-nome>{NOME}</span>! üéâ</strong><br>
    Parab√©ns pela sua dedica√ß√£o!
  </div>
</div>
    
    <!-- ‚úÖ CONFIRMA√á√ÉO DE ENVIO (SEMPRE FORA DOS CARDS) -->
    <div id="evSuccessMsg" class="hidden"></div>

    <div id="evThumbsWrap" class="ev-thumbs"></div>



<div id="evUploadWrap" class="hidden" style="margin-top:14px;">

  <div id="evFilesWrap" class="ev-files">
    <input type="file" class="evFileItem" accept="image/*">
    <input type="file" class="evFileItem" accept="image/*">
    <input type="file" class="evFileItem" accept="image/*">
    <div class="thumb-hint">Formatos JPG/PNG. At√© 3 imagens.</div>
  </div>

  <div id="evAuthWrap" class="hidden" style="text-align:left;margin-top:10px;">
<label class="ev-auth-label">
  <input id="chkAutorizo" type="checkbox">
  <span id="evAuthText" class="ev-auth-text">
    Eu permito o curso divulgar as imagens da minha evolu√ß√£o de forma a chamar novos alunos.
  </span>
</label>

  </div>

  <div class="flex-row" style="margin-top:10px;">
    <button id="evReset" class="btn-sec" type="button" data-busy>Resetar imagens</button>
  </div>

  <button id="evEnviar" class="btn-cta" type="button" data-busy style="margin-top:12px;">Enviar</button>
</div>



<!-- ‚úÖ GERADOR DE IMAGEM (s√≥ quando conclu√≠do) -->
<div id="evFinalWrap" class="hidden" style="margin-top:16px;">
  <div class="ev-block" style="text-align:center;">
    <div class="ev-stage-title" style="text-align:left;">Gerar imagem da sua evolu√ß√£o</div>

    <canvas id="evFinalCanvas" width="1080" height="1350"
  style="width:100%;max-width:520px;border-radius:18px;display:block;margin:0 auto;"></canvas>

    <div class="flex-row" style="margin-top:12px;">
      <button id="evFinalPrevAntes" class="btn-sec" type="button">Trocar arte de antes do curso</button>
      <button id="evFinalNextDepois" class="btn-sec" type="button">Trocar arte recente</button>
    </div>

    <div style="max-width:900px;margin:14px auto 0;text-align:left;">
      <label style="margin:0 0 6px;">Ajustar imagem antes</label>
<input id="evFinalZoomAntes" type="range" min="0" max="1" step="0.001" value="0.5">

      <label style="margin:12px 0 6px;">Ajustar imagem depois</label>
<input id="evFinalZoomDepois" type="range" min="0" max="1" step="0.001" value="0.5">
    </div>

<div class="ev-final-actions" style="margin-top:14px;">
  <button id="evFinalDownload" class="btn-cta"
    style="background:#ff7a1a;color:#fff;">
    Baixar
  </button>
  <button id="evFinalShare" class="btn-cta"
    style="background:#ff7a1a;color:#fff;">
    Compartilhar
  </button>
</div>


    <div class="hint" style="margin-top:10px;">
      Troque as imagens e ajuste o zoom antes de baixar/compartilhar.
    </div>
  </div>
</div>



    
    <button id="evVoltar" class="btn-back" type="button" data-busy style="margin-top:12px;">Voltar</button>
  </div>
</section>

<!-- Modal de imagem -->
<div id="evImgModal" class="modal" aria-hidden="true">
  <div class="modal-card" style="width:min(860px,92vw);">
    <h3 style="margin:0 0 10px;text-align:center;">Visualiza√ß√£o</h3>
<div class="ev-modal-body">
  <img id="evModalImg" alt="Imagem">
</div>

<div class="modal-actions">

  <button id="evOpenAllStage" class="btn-primary" type="button">Abrir em nova aba</button>
  <button id="evCloseModal" class="btn-neutral" type="button">Fechar</button>
</div>

  </div>
</div>

    
    <!-- ENVIO -->
    <section id="envio" class="hidden">
      <p id="artsInfo" class="envio-arts-info hidden">
        Voc√™ j√° enviou <strong id="artsCount">0</strong> artes durante o curso!
      </p>

      <div class="card">
        <div id="limiteWrap" class="hidden" style="text-align:center; margin-bottom:16px;">
          <button class="btn-cta" type="button" disabled>
            ‚ùó Voc√™ j√° enviou o m√°ximo de artes nesta semana ‚ùó
          </button>
          <p style="margin-top:16px; font-size:16px; font-weight:600;">
            Semana que vem voc√™ poder√° enviar novas artes para o feedback dos professores.
          </p>
          <p style="color:#888;">Enquanto isso, aproveite para estudar!</p>
        </div>

        <div id="envioFields">
          <h2>Envio de exerc√≠cio para feedback</h2>
          <div class="hint">Envie no m√°ximo 7 artes por semana.</div>

          <label>M√≥dulo:</label>
          <select id="selModulo" disabled><option>Carregando...</option></select>

          <label>Aula:</label>
          <select id="selAula" disabled><option>Selecione o m√≥dulo primeiro</option></select>

          <label>Envie a arte:</label>
          <div id="filesWrap" class="row">
            <input type="file" class="fileItem" accept="image/*">
            <div class="thumb-hint">Formatos JPG/PNG. At√© 3 envios.</div>
          </div>

          <div class="flex-row">
            <button id="btnAddImagem" class="btn-sec" type="button" data-busy
  style="background:#28a745; color:white; border:none;">
  Adicionar imagem
</button>
            <button id="btnResetar" class="btn-sec" type="button" data-busy>Resetar imagens</button>
          </div>

          <label>Descri√ß√£o</label>
          <textarea id="descricao" rows="5" placeholder="Conte sobre suas dificuldades."></textarea>

          <button id="btnEnviar" class="btn-cta" type="button" data-busy>Enviar</button>
        </div>
      </div>

      <div class="envio-back" style="text-align:center;margin-top:10px;">
        <button id="btnVoltarEnvio" class="btn-back" type="button" data-busy>Voltar</button>
      </div>
    </section>

    <!-- SUCESSO -->
    <section id="sucesso" class="hidden">
      <div class="card">
        <h2>‚úÖ Enviado!</h2>
        <p>Seu desenho ser√° avaliado em breve.</p>
        <button id="btnVoltarMenu" class="btn-sec" type="button" data-busy>Voltar</button>
      </div>
    </section>
  </main>

  <!-- Modal Telefone -->
  <div id="phoneModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <h3 data-nome>Oi {NOME}! Informe seu telefoneüìû</h3>
      <p style="text-align:center;margin:0 0 8px">Usaremos apenas para contato do curso e suporte se necess√°rio.</p>
      <input id="phoneInput" class="input-tel" placeholder="(11) 9 9999-9999" inputmode="numeric" autocomplete="tel">
      <div class="small-hint">Apenas n√∫meros (10 ou 11 d√≠gitos).</div>
      <div class="modal-actions">
        <button id="btnSalvarPhone" class="btn-primary" type="button">Salvar</button>
        <button id="btnCancelarPhone" class="btn-neutral" type="button">Cancelar</button>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="footer-inner">
      <strong>Editora Cr√°s ‚Ä¢ </strong>
      <a href="mailto:contato@editoracras.com">Suporte</a>
      <small>¬© 2025. Todos os direitos reservados.</small>
    </div>
  </footer>

<script>
/* util b√°sico */
const qs  = s => document.querySelector(s);
const qsa = s => Array.from(document.querySelectorAll(s));
const show = el => el.classList.remove("hidden");
const hide = el => el.classList.add("hidden");

function renderNomeAluno(nome){
  document.querySelectorAll("[data-nome]").forEach(el => {
    if (!el.dataset.template) el.dataset.template = el.innerHTML;
    el.innerHTML = el.dataset.template.replaceAll("{NOME}", nome);
  });
}
function getFirstName(full){
  const t = String(full || "").trim().replace(/\s+/g, " ");
  if (!t) return "";
  return t.split(" ")[0];
}

let tokensRestantes = 0;
let artesTotal = 0;
let telefone = "";
let primeiroLogin = false;
let sessao = null, bootstrap = null;

const API_URL   = "https://script.google.com/macros/s/AKfycbwQ9utyV79uWjpVHuBRWbie_2kkgTX-lPBudob49WA2daqn5qdbdqyzhl3LqYC0y_fVuQ/exec";
const MAX_FILES = 3;
let __wasLive = false;

/* --------- badge AO VIVO --------- */
function setLiveMode(on){
  const badge = qs("#liveBadge");
  const box   = qs(".box-feedback");
  const title = qs("#fbTitulo");
  const rowDiaHora = qs("#fbDiaTxt")?.parentElement;

  if (!badge || !box) return;
  badge.style.display = on ? "block" : "none";
  box.classList.toggle("is-live", !!on);

  if (title)      title.style.display = on ? "none" : "";
  if (rowDiaHora) rowDiaHora.style.display = on ? "none" : "";
}

/* üëâ helper novo: sempre reconstr√≥i os spans e popula dia/hora */
function renderDiaHoraFromFeedback(fb){
  const rowDiaHora = qs("#fbDiaTxt")?.parentElement;
  if (!rowDiaHora) return;
  if (!rowDiaHora.dataset.tpl) {
    // guarda o HTML padr√£o caso tenha sido substitu√≠do por texto ‚ÄúAguarde‚Ä¶‚Äù
    rowDiaHora.dataset.tpl = '<strong id="fbDiaTxt" style="display:none"></strong><strong id="fbHoraTxt" style="display:none"></strong>';
  }
  rowDiaHora.innerHTML = rowDiaHora.dataset.tpl;
  rowDiaHora.style.display = "";

  const diaEl = qs("#fbDiaTxt");
  const horEl = qs("#fbHoraTxt");
  if (fb.dia){ diaEl.textContent = fb.dia; diaEl.style.display = "inline"; }
  if (fb.hora){
    horEl.textContent = (fb.dia ? " ‚Ä¢ " : "") + fb.hora;
    horEl.style.display = "inline";
  }
}

/* estado ‚Äúespera pr√≥xima data‚Äù */
function renderFeedbackWaitingUI(){
  const title = qs("#fbTitulo");
  const rowDiaHora = qs("#fbDiaTxt")?.parentElement;
  const rowProf  = qs("#fbProf")?.parentElement;
  const rowSenha = qs("#fbSenha")?.parentElement;
  const rowInfo  = qs("#fbInfo");
  const linkEl   = qs("#fbLink");

  if (title) title.style.display = "";
  if (rowDiaHora){
    rowDiaHora.style.display = "";
    rowDiaHora.textContent = "Aguarde a pr√≥xima data";
  }
  if (rowProf)  rowProf.style.display = "none";
  if (rowSenha) rowSenha.style.display = "none";
  if (rowInfo){ rowInfo.textContent = ""; rowInfo.style.display = "none"; }
  if (linkEl){ linkEl.removeAttribute("href"); linkEl.textContent = ""; linkEl.style.display = "none"; }
}

function weekdayPtToIndex(dia){
  const map = { domingo:0, dom:0, "domingo.":0,
    segunda:1, "segunda-feira":1, seg:1,
    ter√ßa:2, terca:2, "ter√ßa-feira":2, ter:2,
    quarta:3, "quarta-feira":3, qua:3,
    quinta:4, "quinta-feira":4, qui:4,
    sexta:5, "sexta-feira":5, sex:5,
    s√°bado:6, sabado:6, s√°b:6, sab:6 };
  const k = String(dia||"").toLowerCase().trim();
  return (k in map) ? map[k] : null;
}
function buildNextOccurrenceISO(dia, hora){
  const [hh, mm] = String(hora||"").split(":").map(n=>parseInt(n,10));
  if (Number.isNaN(hh) || Number.isNaN(mm)) return null;
  const idx = weekdayPtToIndex(dia);
  if (idx === null) return null;

  const now = new Date();
  const t = new Date(now);
  const delta = (idx - now.getDay() + 7) % 7;
  t.setDate(now.getDate() + delta);
  t.setHours(hh, mm, 0, 0);
  return t.toISOString();
}
function buildThisWeekOccurrenceISO(dia, hora){
  const [hh, mm] = String(hora||"").split(":").map(n=>parseInt(n,10));
  if (Number.isNaN(hh) || Number.isNaN(mm)) return null;
  const idx = weekdayPtToIndex(dia);
  if (idx === null) return null;

  const now = new Date();
  const t = new Date(now);
  const diff = (now.getDay() - idx + 7) % 7;
  t.setDate(now.getDate() - diff);
  t.setHours(hh, mm, 0, 0);
  return t.toISOString();
}

/* üëâ reescrita para n√£o derrubar o conte√∫do quando h√° data/hora */
function updateLiveBadgeFromBootstrap(){
  const fb = bootstrap?.feedback || {};
  const hasDate = !!(fb.dia && fb.hora);

  // sem data/hora ‚Üí modo espera
  if (!hasDate){
    setLiveMode(false);
    renderFeedbackWaitingUI();
    __wasLive = false;
    return;
  }

  // temos data/hora ‚Üí calcula janelas
  const thisISO = buildThisWeekOccurrenceISO(fb.dia, fb.hora);
  const nextISO = buildNextOccurrenceISO(fb.dia, fb.hora);
  if (!thisISO || !nextISO){
    setLiveMode(false);
    renderFeedbackWaitingUI();
    __wasLive = false;
    return;
  }

  const durMin    = Number(fb.duracaoMin ?? 90);
  const thisStart = new Date(thisISO).getTime();
  const thisEnd   = thisStart + durMin * 60 * 1000;
  const nextStart = new Date(nextISO).getTime();
  const now       = Date.now();

  if (fb.atualizadoEm){
    const upd = new Date(fb.atualizadoEm).getTime();
    if (!Number.isNaN(upd) && now < Math.max(upd, thisStart)){
      setLiveMode(false);
      renderFeedbackWaitingUI();
      __wasLive = false;
      return;
    }
  }

  if (now >= thisStart && now <= thisEnd){
    // durante a live
    setLiveMode(true);
    renderDiaHoraFromFeedback(fb);
    __wasLive = true;
    return;
  }

  if (now > thisEnd && now < nextStart){
    // depois da live atual e antes da pr√≥xima ‚Üí mostra a pr√≥xima (n√£o ‚ÄúAguarde‚Äù)
    setLiveMode(false);
    renderDiaHoraFromFeedback(fb);
    __wasLive = false;
    return;
  }

  // estado normal (antes da live)
  setLiveMode(false);
  renderDiaHoraFromFeedback(fb);
  __wasLive = false;
}

/* --------- UI do bot√£o de envio --------- */
function applyAllowUploadUI(){
  const btnEnvio  = qs("#btnAbrirEnvio");
  const prazoNote = qs("#prazoEnvioNote");
  if (!btnEnvio) return;

  if (!bootstrap?.allowUpload){
    btnEnvio.removeAttribute("disabled");
    btnEnvio.setAttribute("aria-disabled","true");
    btnEnvio.textContent = "Envio de exerc√≠cio indispon√≠vel";
    btnEnvio.style.opacity = "";
    if (prazoNote) prazoNote.style.display = "none";
  } else {
    btnEnvio.removeAttribute("aria-disabled");
    btnEnvio.removeAttribute("disabled");
    btnEnvio.textContent = "Envie os exerc√≠cios para feedback";
    btnEnvio.style.opacity = "";
    if (prazoNote && bootstrap?.janela?.endISO){
      const end = new Date(bootstrap.janela.endISO);
      const hh = String(end.getHours()).padStart(2,"0");
      const mm = String(end.getMinutes()).padStart(2,"0");
      const diaSemana = (bootstrap.feedback?.dia || "").trim();
      prazoNote.textContent = `Envios liberados at√© ${hh}:${mm}${diaSemana ? ` - ${diaSemana}` : ""}.`;
      prazoNote.style.display = "block";
    } else if (prazoNote){
      prazoNote.style.display = "none";
    }
  }
}

/* timers da janela (apenas para o bot√£o) */
const windowTimers = { start:null, end:null, poll:null };
function clearWindowTimers(){
  if (windowTimers.start) clearTimeout(windowTimers.start), windowTimers.start=null;
  if (windowTimers.end)   clearTimeout(windowTimers.end),   windowTimers.end=null;
  if (windowTimers.poll)  clearInterval(windowTimers.poll), windowTimers.poll=null;
}
async function refreshBootstrap(){
  try{
    const url = `${API_URL}?action=portalBootstrap&curso=${encodeURIComponent(sessao.curso)}&email=${encodeURIComponent(sessao.email)}`;
    const resp = await fetch(url, { cache: "no-store" });
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const data = await resp.json() || {};

    if (!bootstrap || typeof bootstrap !== "object") bootstrap = {};
    bootstrap.allowUpload = !!data.allowUpload;
    bootstrap.janela      = data.janela ?? null;
    bootstrap.feedback    = (data.feedback && typeof data.feedback === "object") ? data.feedback : {};

    const t = Number(data.tokensRestantes);
    bootstrap.tokensRestantes = Number.isFinite(t) ? t : (bootstrap.tokensRestantes ?? 0);
    tokensRestantes = bootstrap.tokensRestantes;

    applyAllowUploadUI();
    updateUIForTokens();
    updateLiveBadgeFromBootstrap();
  } catch (e){
    console.error("refreshBootstrap() falhou:", e);
  }
}
function scheduleUploadWindow(){
  clearWindowTimers();
  const sISO = bootstrap?.janela?.startISO || null;
  const eISO = bootstrap?.janela?.endISO   || null;

  if (!sISO || !eISO){
    bootstrap.allowUpload = false;
    applyAllowUploadUI();
    updateLiveBadgeFromBootstrap();
    return;
  }

  const now   = Date.now();
  const start = new Date(sISO).getTime();
  const end   = new Date(eISO).getTime();

  bootstrap.allowUpload = (now >= start && now <= end);
  applyAllowUploadUI();
  updateLiveBadgeFromBootstrap();

  if (now < start){
    windowTimers.start = setTimeout(async () => {
      bootstrap.allowUpload = true;
      applyAllowUploadUI();
      await refreshBootstrap();
      updateLiveBadgeFromBootstrap();
    }, Math.max(0, start - now));
  }
  if (now < end){
    windowTimers.end = setTimeout(async () => {
      bootstrap.allowUpload = false;
      applyAllowUploadUI();
      if (!qs("#envio").classList.contains("hidden")){
        hide(qs("#envio")); show(qs("#dashboard"));
        alert("O per√≠odo de envio foi encerrado.");
      }
      await refreshBootstrap();
      updateLiveBadgeFromBootstrap();
    }, Math.max(0, end - now));
  }
  windowTimers.poll = setInterval(async () => {
    const n = Date.now();
    if (n > end + 5*60*1000) { clearWindowTimers(); }
    await refreshBootstrap();
    updateLiveBadgeFromBootstrap();
  }, 60_000);
}

/* --------- Helpers telefone --------- */
function onlyDigits(s){ return String(s||"").replace(/\D+/g,""); }
function isValidBRPhone(d){ return /^\d{10,11}$/.test(d); }
function formatBRPhone(d){
  const x = onlyDigits(d);
  if (x.length === 11) return `(${x.slice(0,2)}) ${x.slice(2,7)}-${x.slice(7)}`;
  if (x.length === 10) return `(${x.slice(0,2)}) ${x.slice(2,6)}-${x.slice(6)}`;
  return x;
}
function showPhoneModal(){
  const m = qs("#phoneModal");
  const inp = qs("#phoneInput");
  inp.value = formatBRPhone(telefone||"");
  m.classList.add("show");
  m.setAttribute("aria-hidden","false");
  setTimeout(()=>inp.focus(), 50);
}
function hidePhoneModal(){
  const m = qs("#phoneModal");
  m.classList.remove("show");
  m.setAttribute("aria-hidden","true");
}
async function savePhone(){
  const raw = onlyDigits(qs("#phoneInput").value);
  if (!isValidBRPhone(raw)){
    alert("Digite um telefone v√°lido (10 ou 11 d√≠gitos).");
    return;
  }
  try{
    setLoading(true, "Salvando telefone‚Ä¶");
    const body = { action:"updatePhone", curso:sessao.curso, email:sessao.email, telefone: raw };
    const r = await fetch(API_URL, { method:"POST", body: JSON.stringify(body) });
    const d = await r.json();
    if (!d.ok) throw new Error(d.message || "Falha ao salvar telefone.");
    telefone = d.telefone;
    primeiroLogin = true;
    renderTopbarPhone();
    hidePhoneModal();
    alert("Telefone atualizado!");
  }
  
  catch (e) {
    console.error("Erro no savePhone:", e);

    if (e.message === "Failed to fetch") {
      alert("Eita! Problema na conex√£o. Tente novamente em alguns segundos.");
    } else {
      alert("Erro ao salvar telefone: " + (e.message || e));
    }
  }

  finally {
    setLoading(false);
  }
}
  
function renderTopbarPhone(){
  const tb = qs(".topbar");
  const old = tb.querySelector(".topbar-phone");
  if (old) old.remove();
  const span = document.createElement("span");
  span.className = "topbar-phone";
  const telText = telefone ? formatBRPhone(telefone) : "adicionar telefone";
  span.innerHTML = ` ‚Ä¢ üìû ${telText} <a id="linkEditarTel">(alterar)</a>`;
  tb.appendChild(span);
  qs("#linkEditarTel").onclick = (e)=>{ e.preventDefault(); showPhoneModal(); };
}

/* --------- Bootstrap inicial --------- */
async function carregarBootstrap(curso, email){
  try{
    const r = await fetch(
      `${API_URL}?action=portalBootstrap&curso=${encodeURIComponent(curso)}&email=${encodeURIComponent(email)}`,
      { cache:'no-store' }
    );
    bootstrap = await r.json();

    if(!bootstrap || bootstrap.allowed !== true){ location.replace("index.html"); return; }

    const fullName = bootstrap.nome || "";
    const first = getFirstName(fullName) || (sessao.email?.split("@")[0] || "aluno");
    qs(".topbar").textContent = `[${first}]`;
    renderNomeAluno(first);

    const logo = qs("#cursoLogo");
    if (bootstrap.logoUrl){ logo.src = bootstrap.logoUrl; logo.style.display = "block"; }

    telefone = String(bootstrap.telefone || "");
    primeiroLogin = !!bootstrap.primeiroLogin;
    renderTopbarPhone();

    const dr = +bootstrap.diasRestantes || 0;
    qs("#diasRestantes").textContent = dr > 0
      ? (dr === 1 ? `[${dr}] dia restante de acesso ao curso.` : `[${dr}] dias restantes de acesso ao curso.`)
      : "Acesso expirado.";

    if (dr <= 30 && bootstrap.desconto?.cupom){
      qs("#cupomBox").style.display = "block";
      qs("#cupomCod").textContent = bootstrap.desconto.cupom;
      qs("#cupomPerc").textContent = bootstrap.desconto.porcentagem;
      qs("#cupomLink").href = bootstrap.desconto.link;
    }

    const fb = bootstrap.feedback || {};
    const rowDiaHora = qs("#fbDiaTxt").parentElement;
    const rowProf    = qs("#fbProf").parentElement;
    const rowSenha   = qs("#fbSenha").parentElement;
    const rowInfo    = qs("#fbInfo");
    const linkEl     = qs("#fbLink");

    if (!rowDiaHora.dataset.tpl) rowDiaHora.dataset.tpl = rowDiaHora.innerHTML;

    const hasDate    = !!(fb.dia || fb.hora);
    const hasDetails = !!(fb.professor || fb.senha || fb.info || fb.link);

    if (!hasDate && !hasDetails){
      rowDiaHora.textContent = "Aguarde a pr√≥xima data";
      rowDiaHora.style.display = "";
      rowProf.style.display  = "none";
      rowSenha.style.display = "none";
      rowInfo.style.display  = "none";
      linkEl.style.display   = "none";
      setLiveMode(false);
    } else {
      if (hasDate){
        renderDiaHoraFromFeedback(fb);
      } else {
        rowDiaHora.textContent = "";
        rowDiaHora.style.display = "none";
      }

      if (fb.professor){ qs("#fbProf").textContent = fb.professor; rowProf.style.display = ""; }
      else { rowProf.style.display = "none"; }

      if (fb.link){
        linkEl.href = fb.link;
        linkEl.textContent = "Entrar na aula";
        linkEl.setAttribute("aria-label", "Entrar na aula ao vivo");
        linkEl.style.display = "inline";
      } else {
        linkEl.removeAttribute("href");
        linkEl.textContent = "";
        linkEl.style.display = "none";
      }

      if (fb.senha){ qs("#fbSenha").textContent = fb.senha; rowSenha.style.display = ""; }
      else { rowSenha.style.display = "none"; }

      if (fb.info){ rowInfo.textContent = fb.info; rowInfo.style.display = ""; }
      else { rowInfo.textContent = ""; rowInfo.style.display = "none"; }
    }

    updateLiveBadgeFromBootstrap();

    const gravCard = qs("#gravadaCard");
    const gravURL  = String(fb.aulaGravada || "").trim();
    if (gravURL){
      qs("#ultimaGravada").href = gravURL;
      qs("#ultimaGravada").textContent = gravURL;
      if (gravCard) gravCard.style.display = "block";
    } else {
      qs("#ultimaGravada").removeAttribute("href");
      qs("#ultimaGravada").textContent = "";
      if (gravCard) gravCard.style.display = "none";
    }

    tokensRestantes = Number(bootstrap.tokensRestantes ?? 0);
    artesTotal = Number(bootstrap.artesTotal || 0);

    applyAllowUploadUI();
    scheduleUploadWindow();

    if (!primeiroLogin || !telefone){
      setTimeout(showPhoneModal, 300);
    }

    updateUIForTokens();
        evRenderButton();

 } catch (e) {
  console.error("Erro no carregarBootstrap:", e);
  alert("‚ùå Falha ao carregar seus dados. Tente novamente.\n\nDetalhes t√©cnicos: " + (e?.message || e));
  location.replace("index.html");
}
}

/* --------- Abertura de envio / listas --------- */
async function abrirEnvio(){
  if (!bootstrap?.allowUpload){
    alert("Envio indispon√≠vel no momento. Aguarde a pr√≥xima data de feedback.");
    return;
  }
  setLoading(true, "Carregando envio‚Ä¶");
  hide(qs("#dashboard"));

  resetFiles();
  qs("#descricao").value = "";

  const info  = qs("#artsInfo");
  const count = qs("#artsCount");
  if (artesTotal > 0){ count.textContent = artesTotal; show(info); }
  else { hide(info); }

  await carregarModulos();
  show(qs("#envio"));
  window.scrollTo({top:0,behavior:"smooth"});
  setLoading(false);

  updateUIForTokens();
}
async function carregarModulos(){
  const sel=qs("#selModulo"),selA=qs("#selAula");
  sel.disabled=true;sel.innerHTML="<option>Carregando...</option>";
  selA.disabled=true;selA.innerHTML="<option>Selecione o m√≥dulo primeiro</option>";
  try{
    const r=await fetch(`${API_URL}?action=listModules&curso=${encodeURIComponent(sessao.curso)}`);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const d=await r.json(); const mods=Array.isArray(d.modulos)?d.modulos:[];
    sel.innerHTML="<option value=''>Selecione o m√≥dulo</option>";
    mods.forEach(m=>{const o=document.createElement("option");o.value=m;o.textContent=m;sel.appendChild(o);});
    sel.disabled=false; sel.onchange=carregarAulas;
  }catch{sel.innerHTML="<option>Erro ao carregar. Atualize a p√°gina</option>";}
}
async function carregarAulas(){
  const modulo=qs("#selModulo").value,sel=qs("#selAula");
  if(!modulo){sel.innerHTML="<option>Selecione o m√≥dulo primeiro</option>";return;}
  sel.innerHTML="<option>Carregando aulas...</option>";
  try{
    const r=await fetch(`${API_URL}?action=listLessons&curso=${encodeURIComponent(sessao.curso)}&modulo=${encodeURIComponent(modulo)}`);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const d=await r.json(); const aulas=Array.isArray(d.aulas)?d.aulas:[];
    sel.innerHTML="<option value=''>Selecione a aula</option>";
    aulas.forEach(a=>{const o=document.createElement("option");o.value=a;o.textContent=a;sel.appendChild(o);});
    sel.disabled=false;
  }catch{sel.innerHTML="<option>Erro ao carregar aulas</option>";}
}

/* --------- UX / TOKENS --------- */
function countSelectedFiles(){
  return qsa("#filesWrap input[type='file']").map(i => i.files[0]).filter(Boolean).length;
}
function updateUIForTokens(){
  const btnEnviar  = qs("#btnEnviar");
  const btnAdd     = qs("#btnAddImagem");
  const btnReset   = qs("#btnResetar");
  const wrapForm   = qs("#envioFields");
  const wrapLimit  = qs("#limiteWrap");

  const selected   = qsa("#filesWrap input[type='file']").map(i => i.files[0]).filter(Boolean).length;
  const inputsQtd  = qsa("#filesWrap input[type='file']").length;

  if (tokensRestantes <= 0){
    if (wrapForm)  wrapForm.style.display = "none";
    if (wrapLimit) wrapLimit.classList.remove("hidden");
    if (btnEnviar){
      btnEnviar.disabled = false;
      btnEnviar.textContent = "‚ùó Voc√™ j√° enviou o m√°ximo desta semana";
      btnEnviar.style.opacity = "0.9";
    }
    if (btnAdd)   btnAdd.style.display   = "none";
    if (btnReset) btnReset.style.display = "none";
    return;
  }

  if (wrapForm)  wrapForm.style.display = "block";
  if (wrapLimit) wrapLimit.classList.add("hidden");

  if (btnEnviar){
    btnEnviar.disabled = false;
    btnEnviar.textContent = "Enviar";
    btnEnviar.style.opacity = "";
  }

  const deveMostrarAdd = (
    tokensRestantes > 1 &&
    selected < tokensRestantes &&
    inputsQtd < MAX_FILES
  );
  if (btnAdd)   btnAdd.style.display   = deveMostrarAdd ? "inline-block" : "none";
  if (btnReset) btnReset.style.display = "inline-block";
}
function resetFiles(){
  qs("#filesWrap").innerHTML =
    '<input type="file" class="fileItem" accept="image/*">' +
    '<div class="thumb-hint">Formatos JPG/PNG. At√© 3 envios.</div>';
  updateUIForTokens();
}
function addFileInput(){
  if (tokensRestantes <= 0){ return; }
  const wrap         = qs("#filesWrap");
  const inputs       = qsa("#filesWrap input[type='file']");
  const inputsQtd    = inputs.length;
  const selectedNow  = inputs.map(i => i.files[0]).filter(Boolean).length;

  if (inputsQtd >= MAX_FILES) return;
  if (tokensRestantes <= 1)   return;
  if (selectedNow >= tokensRestantes) return;

  const inp = document.createElement("input");
  inp.type = "file";
  inp.accept = "image/*";
  inp.className = "fileItem";
  wrap.insertBefore(inp, wrap.lastElementChild);

  updateUIForTokens();
}
function updateAddBtnVisibility(){ updateUIForTokens(); }
/* --------- Loading message rotator (envio) --------- */
let __loadingMsgTimers = [];
let __loadingMsgRunning = false;

function clearLoadingMessageRotation(){
  __loadingMsgTimers.forEach(t => clearTimeout(t));
  __loadingMsgTimers = [];
  __loadingMsgRunning = false;
}

/**
 * Inicia mensagens progressivas no overlay global.
 * - S√≥ muda o texto se o overlay ainda estiver vis√≠vel.
 * - Se o envio terminar, chame clearLoadingMessageRotation().
 */
function startLoadingMessageRotation(){
  clearLoadingMessageRotation();
  __loadingMsgRunning = true;

  const steps = [
    { after: 0,      msg: "Embalando a sua arte..." },
    { after: 6000,   msg: "Enviando‚Ä¶" },              // 3s -> 9s
    { after: 12000,  msg: "Quase l√°!" },                          // 6s -> 18s
    { after: 25000,  msg: "S√≥ mais um pouco‚Ä¶" },                          // 11s -> 33s
    { after: 40000,  msg: "O professor est√° sendo notificado!" }, // 14s -> 42s
    { after: 50000,  msg: "S√≥ mais um pouco‚Ä¶" },                  // 17s -> 51s
    { after: 80000,  msg: "Est√° demorando mais do que o normal." }, // 20s -> 60s
    { after: 100000,  msg: "A sua internet est√° boa?" },           // 30s -> 90s
    { after: 155000, msg: "Se continuar, tente trocar de rede e reenviar." }, // 45s -> 135s
  ];

  const isOverlayVisible = () => {
    const box = document.getElementById("global-loading");
    return box && box.style.display !== "none";
  };

  steps.forEach(step => {
    const t = setTimeout(() => {
      if (!__loadingMsgRunning) return;
      if (!isOverlayVisible()) return;
      // reusa seu setLoading para atualizar o texto, sem mexer no estado

      const box = document.getElementById("global-loading");
if (!box) return;

      
      setLoading(true, step.msg);
    }, step.after);
    __loadingMsgTimers.push(t);
  });
}

/* --------- Envio --------- */
async function enviarExercicio(){
  const modulo = qs("#selModulo").value.trim(),
        aula   = qs("#selAula").value.trim(),
        desc   = qs("#descricao").value.trim();

  if(!modulo) return alert("Selecione o m√≥dulo.");
  if(!aula)   return alert("Selecione a aula.");

  if (tokensRestantes <= 0){
    alert("Semana que vem voc√™ conseguir√° enviar novamente. Aproveite esse tempo para estudar o feedback que te foi passado.");
    return;
  }

  if (!bootstrap.allowUpload){
    alert("O envio s√≥ fica dispon√≠vel ap√≥s a nova data de feedback ser publicada.");
    return;
  }

  const chosen = qsa("#filesWrap input[type='file']").map(i => i.files[0]).filter(Boolean);
  if(!chosen.length) return alert("Envie pelo menos uma imagem.");
  if(chosen.length > MAX_FILES) return alert(`M√°ximo de ${MAX_FILES} imagens.`);
  if(chosen.length > tokensRestantes){
    const resto = tokensRestantes;
    alert(resto > 0
      ? `Voc√™ s√≥ tem ${resto} envio(s) restante(s) nesta semana.`
      : "Semana que vem voc√™ conseguir√° enviar novamente. Aproveite esse tempo para estudar o feedback que te foi passado.");
    return;
  }

setLoading(true, "Enviando seu desenho‚Ä¶");
startLoadingMessageRotation();


  try{
    const files=[];
    for(const f of chosen){
      const base64 = await new Promise((res, rej)=>{
        const fr = new FileReader();
        fr.onload  = () => res(fr.result.split(",")[1]);
        fr.onerror = () => rej();
        fr.readAsDataURL(f);
      });
      files.push({name:f.name,type:f.type,content:base64});
    }

    const fd = new FormData();
    fd.append("action","uploadExercise");
    fd.append("curso",  sessao.curso);
    fd.append("email",  sessao.email);
    fd.append("nome",   bootstrap.nome || "");
    fd.append("modulo", modulo);
    fd.append("aula",   aula);
    fd.append("descricao", desc);
    fd.append("files", JSON.stringify(files));

    const r = await fetch(API_URL, { method: "POST", body: fd });

    if (!r.ok) throw new Error(`HTTP ${r.status}`);

    let d;
    try { d = await r.json(); }
    catch { throw new Error("Resposta inv√°lida do servidor (n√£o-JSON)."); }

    if(!d.ok){
      if (d.message === "limit_exceeded"){
        alert("Semana que vem voc√™ conseguir√° enviar novamente. Aproveite esse tempo para estudar o feedback que te foi passado.");
        return;
      }
      if (d.message === "envio_fora_da_janela"){
        alert("O envio s√≥ fica dispon√≠vel ap√≥s a nova data de feedback ser publicada e at√© pouco tempo ap√≥s o hor√°rio da aula.");
        bootstrap.allowUpload = false;
        applyAllowUploadUI();
        if (!qs("#envio").classList.contains("hidden")){
          hide(qs("#envio")); show(qs("#dashboard"));
        }
        return;
      }
      throw new Error(d.message || "Falha");
    }

    if(typeof d.tokensRestantes === "number"){
      tokensRestantes = d.tokensRestantes;
    }

    resetFiles();
    hide(qs("#envio"));
    show(qs("#sucesso"));
    updateUIForTokens();

    } catch (e) {
    console.error("Erro no enviarExercicio:", e);
    if (e.message === "Failed to fetch") {
      alert("Eita! Problema na conex√£o. Tente novamente em alguns segundos!.");
    } else {
      alert("Erro ao enviar exerc√≠cio: " + (e.message || e));
    }
  } finally {
        clearLoadingMessageRotation();
    setLoading(false);


  }
}
/* =========================
 * EVOLU√á√ÉO ‚Äì Front
 * ========================= */
/* --------- Loading message rotator (EVOLU√á√ÉO) --------- */
let __evLoadingMsgTimers = [];
let __evLoadingMsgRunning = false;

function clearEvLoadingMessageRotation(){
  __evLoadingMsgTimers.forEach(t => clearTimeout(t));
  __evLoadingMsgTimers = [];
  __evLoadingMsgRunning = false;
}

function startEvLoadingMessageRotation(){
  clearEvLoadingMessageRotation();
  __evLoadingMsgRunning = true;

  const steps = [
    { after: 0,      msg: "Analisando seu progresso..." },
    { after: 4000,   msg: "Carregando a sua evolu√ß√£o" },
    { after: 10000,  msg: "Enviando a sua arte..." },
    { after: 25000,  msg: "Quase l√°..." },
    { after: 40000,  msg: "S√≥ mais um pouco..." },
    { after: 80000,  msg: "Est√° demorando mais do que o normal." },
    { after: 100000, msg: "A sua internet est√° boa?" },
    { after: 155000, msg: "Se continuar, tente trocar de rede e reenviar!" }
  ];

  const isOverlayVisible = () => {
    const box = document.getElementById("global-loading");
    return box && box.style.display !== "none";
  };

  steps.forEach(step => {
    const t = setTimeout(() => {
      if (!__evLoadingMsgRunning) return;
      if (!isOverlayVisible()) return;
      setLoading(true, step.msg);
    }, step.after);
    __evLoadingMsgTimers.push(t);
  });
}


  
const EV_MAX_FILES = 3;
let __evState = null;

let __evModalStage = "";
let __evModalUrls = [];
let __evLastSuccess = null; // { html: string, at: number }
  
function evSetAuthError(on){
  const t = qs("#evAuthText");
  if (!t) return;

  t.classList.toggle("is-error", !!on);

  if (on){
    t.scrollIntoView({
      behavior: "smooth",
      block: "center"
    });
  }
}

function evOpenAllFromModalStage(){
  if (!__evModalUrls || !__evModalUrls.length){
    alert("N√£o h√° outras imagens para abrir nesta etapa.");
    return;
  }

  // abre 1‚Äì3 abas (navegadores tendem a permitir pois √© clique do usu√°rio)
  __evModalUrls.slice(0, 3).forEach(u => {
    const full = driveThumbUrl(u, 1600); // usa imagem maior quando for Drive
    window.open(full, "_blank", "noopener");
  });
}

  
function driveFileIdFromUrl(url){
  const s = String(url||"").trim();

  // formato: /d/ID/
  let m = s.match(/\/d\/([a-zA-Z0-9_-]{10,})/);
  if (m) return m[1];

  // formato: ?id=ID (inclui open?id=ID)
  m = s.match(/[?&]id=([a-zA-Z0-9_-]{10,})/);
  if (m) return m[1];

  // formato: uc?export=view&id=ID
  m = s.match(/uc\?export=view&id=([a-zA-Z0-9_-]{10,})/);
  if (m) return m[1];

  return "";
}


function driveThumbUrl(url, size = 300){
  const id = driveFileIdFromUrl(url);
  if (!id) return url; // fallback
  return `https://drive.google.com/thumbnail?id=${id}&sz=w${size}`;
}


  
function evEnabled(){ return !!(bootstrap && bootstrap.evolucao && bootstrap.evolucao.enabled); }

function evShowSection(){
  hide(qs("#dashboard"));
  hide(qs("#envio"));
  hide(qs("#sucesso"));
  show(qs("#evolucao"));
  window.scrollTo({top:0,behavior:"smooth"});
}

function evBackToMenu(){
  // üî¥ limpa confirma√ß√£o de envio
  __evLastSuccess = null;

  const msg = qs("#evSuccessMsg");
  if (msg){
    msg.classList.add("hidden");
    msg.innerHTML = "";
  }

  hide(qs("#evolucao"));
  show(qs("#dashboard"));
  window.scrollTo({ top: 0, behavior: "smooth" });
}


function evRenderButton(){
  const btn = qs("#btnEvolucao");
  if (!btn) return;
  if (!evEnabled()){
    btn.style.display = "none";
    return;
  }
  btn.style.display = "block";

  const st = bootstrap.evolucao;
  btn.style.background = (st.buttonState === "green") ? "#28a745" : "#f4a300";
  btn.style.color      = (st.buttonState === "green") ? "#fff" : "#111";
}

function evGetAllThumbs(){
  if (!__evState) return [];
  const imgs = __evState.images || {};
  const out = [];
  ["antes","2","6","11"].forEach(k=>{
    (imgs[k]||[]).forEach(url => out.push({stage:k, url}));
  });
  return out;
}

function evOpenModal(url, stageKey = "", stageUrls = []){
  __evModalStage = stageKey || "";
  __evModalUrls  = Array.isArray(stageUrls) ? stageUrls : [];

  qs("#evModalImg").src = url;

  const m = qs("#evImgModal");
  m.classList.add("show");
  m.setAttribute("aria-hidden","false");
}

function evCloseModal(){
  const m = qs("#evImgModal");
  m.classList.remove("show");
  m.setAttribute("aria-hidden","true");
  qs("#evModalImg").removeAttribute("src");
}

function evResetFiles(){
  qs("#evFilesWrap").innerHTML =
    '<input type="file" class="evFileItem" accept="image/*">' +
    '<input type="file" class="evFileItem" accept="image/*">' +
    '<input type="file" class="evFileItem" accept="image/*">' +
    '<div class="thumb-hint">Formatos JPG/PNG. At√© 3 imagens.</div>';
}



function evCountSelected(){
  return Array.from(document.querySelectorAll("#evFilesWrap input[type='file']"))
    .map(i=>i.files && i.files[0]).filter(Boolean).length;
}

function evUpdateAddBtn(){
  const inputs = Array.from(document.querySelectorAll("#evFilesWrap input[type='file']"));
  const btnAdd = qs("#evAddImg");
  const selected = evCountSelected();
  const canAdd = inputs.length < EV_MAX_FILES && selected < EV_MAX_FILES;
  if (btnAdd) btnAdd.style.display = canAdd ? "inline-block" : "none";
}

function evStageLabel(k){
  if (k === "antes") return "Antes do curso";
  if (k === "2") return "2 meses";
  if (k === "6") return "6 meses";
  if (k === "11") return "11 meses";
  return "";
}
function escapeHtml_(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function formatDateBR_(iso){
  const d = new Date(iso);
  if (Number.isNaN(d.getTime())) return "";
  const dd = String(d.getDate()).padStart(2,"0");
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const yy = d.getFullYear();
  return `${dd}/${mm}/${yy}`;
}

  
function evRenderPage(){
  __evState = bootstrap.evolucao;

  const title = qs("#evTitle");
  const subtitle = qs("#evSubtitle");
  const thumbsWrap = qs("#evThumbsWrap");
const uploadWrap = qs("#evUploadWrap");
if (uploadWrap) hide(uploadWrap);


  const authWrap = qs("#evAuthWrap");

const msg = qs("#evSuccessMsg");
if (msg){
  // mostra somente se existir um sucesso recente (ex.: √∫ltimos 10 min)
  const ok = __evLastSuccess && (Date.now() - __evLastSuccess.at) < 10 * 60 * 1000;
  if (ok){
    msg.classList.remove("hidden");
    msg.innerHTML = __evLastSuccess.html;
  } else {
    msg.classList.add("hidden");
    msg.innerHTML = "";
    __evLastSuccess = null;
  }
}


  
  if (!__evState || !__evState.enabled){
    title.textContent = "Minha evolu√ß√£o";
    subtitle.textContent = "Indispon√≠vel no momento.";
    thumbsWrap.innerHTML = "";
    hide(uploadWrap);
    return;
  }

  const pending = __evState.pendingStage;         // "antes"|"2"|"6"|"11"|null
  const canInteract = !!__evState.canInteract;
  const daysToUnlock = Number(__evState.daysToUnlock || 0);



// t√≠tulo/subt√≠tulo
title.textContent = "Minha evolu√ß√£o";

const done = qs("#evDoneMsg");

if (!pending){
  subtitle.innerHTML = "";      // n√£o mostra nada no topo
  hide(uploadWrap);

  if (done) done.classList.remove("hidden"); // mostra embaixo

} else if (canInteract){
  subtitle.innerHTML = "";      // liberado, sem aviso no topo
  show(uploadWrap);

  if (done) done.classList.add("hidden");    // esconde embaixo

  if (pending === "2"){
    show(authWrap);
    evSetAuthError(false);
  } else {
    hide(authWrap);
    const chk = qs("#chkAutorizo");
    if (chk) chk.checked = false;
    evSetAuthError(false);
  }

  evResetFiles();               // ‚úÖ fica s√≥ aqui (n√£o duplica embaixo)

} else {
  // bloqueado
  subtitle.innerHTML =
    `<span class="ev-badge ev-orange">Aguardando</span> Faltam <strong>${daysToUnlock}</strong> dia(s) para voc√™ conseguir subir novas artes!`;
  hide(uploadWrap);

  if (done) done.classList.add("hidden");    // esconde embaixo
}




  
 // ---------- THUMBS (etapas) em BLOCOS ----------
const imgs = (__evState && __evState.images) ? __evState.images : {};
const comments = (__evState && __evState.comments) ? __evState.comments : {};

const STAGES = [
  { key:"antes", title:"Antes do curso" },
  { key:"2",     title:"Depois de 2 meses" },
  { key:"6",     title:"Depois de 6 meses" },
  { key:"11",    title:"Depois de 11 meses" },
];

// visibilidade por PROGRESSO (sequ√™ncia r√≠gida)
// - se conclu√≠do: mostra tudo
// - sen√£o: mostra s√≥ at√© a etapa PENDENTE (inclusive), mesmo que j√° tenha ‚Äútempo‚Äù para mais
const order = ["antes","2","6","11"];
let visibleKeys = [];

if (!pending) {
  visibleKeys = order.slice(); // conclu√≠do => mostra tudo
} else {
  const idx = order.indexOf(pending);
  visibleKeys = order.slice(0, (idx === -1 ? 1 : idx + 1));
}

// seguran√ßa
if (!visibleKeys.length) visibleKeys = ["antes"];


  

thumbsWrap.innerHTML = visibleKeys.map(k => {
  const meta = STAGES.find(s => s.key === k);
  const arr = Array.isArray(imgs[k]) ? imgs[k] : [];

  // ‚úÖ aviso s√≥ no bloco da etapa pendente e liberada
  const showBanner = (canInteract && pending === k);
  const banner = showBanner
    ? `<div class="ev-stage-banner">
         <span class="ev-badge ev-green">Dispon√≠vel</span>
         <span>Envie at√© 3 imagens da etapa: <strong>${evStageLabel(k)}</strong>.</span>
       </div>`
    : "";

  const grid = arr.length
    ? `
      <div class="ev-stage-grid">
        ${arr.map(url => {
          const thumb = driveThumbUrl(url, 300);
          const full  = driveThumbUrl(url, 1600);
          return `<img class="ev-thumb" src="${thumb}" data-full="${full}" data-stage="${k}" alt="Imagem" title="Clique para ampliar">`;
        }).join("")}
      </div>
    `
    : `<p class="hint" style="margin:6px 0 0;">Sem imagens nesta etapa.</p>`;
  const c = comments[k]; // null ou { text, dateISO }
const commentHtml = (c && c.text)
  ? `
    <div class="ev-prof-wrap">
      <div class="ev-prof-title">Coment√°rio do professor:</div>
      <div class="ev-prof-text">
        ${escapeHtml_(c.text)}
      </div>
      <div class="ev-prof-date">
        ${formatDateBR_(c.dateISO)}
      </div>
    </div>
  `
  : "";


return `
  <div class="ev-block" data-ev-stage="${k}">
      <div class="ev-stage-title">${meta ? meta.title : k}</div>
      ${banner}
      ${grid}
      ${commentHtml}
    </div>
  `;


  
}).join("");

thumbsWrap.querySelectorAll(".ev-thumb").forEach(img => {
  img.addEventListener("click", ()=> {
    const full  = img.getAttribute("data-full") || img.src;
    const stage = img.getAttribute("data-stage") || "";
    const urls  = (__evState && __evState.images && __evState.images[stage]) ? __evState.images[stage] : [];
    evOpenModal(full, stage, urls);
  });
});

// --- montar upload dentro do card da etapa pendente (OK), mas VOLTAR sempre fora ---
const section  = qs("#evolucao");

// garante que n√£o fique solto em lugar nenhum
hide(uploadWrap);

const btnVoltar = qs("#evVoltar");
const root = qs("#evolucao .ev-root");

// 1) Upload pode ficar dentro do card pendente (quando liberado)
if (pending && canInteract){
  const mount = thumbsWrap.querySelector(`[data-ev-stage="${pending}"]`);
  if (mount){
    show(uploadWrap);
    mount.appendChild(uploadWrap);
  }
}

// 2) VOLTAR sempre no final do root (fora dos cards brancos)
if (btnVoltar && root){
  root.appendChild(btnVoltar);
  btnVoltar.style.display = "block"; // garante que nunca ‚Äúsome‚Äù
}


evFinal_showIfDone();


  // guarda etapa atual no DOM
  qs("#evolucao").dataset.pendingStage = pending || "";
  qs("#evolucao").dataset.canInteract = canInteract ? "1" : "0";
}


async function evToBase64(file){
  return await new Promise((res, rej)=>{
    const fr = new FileReader();
    fr.onload = ()=> res(String(fr.result).split(",")[1]);
    fr.onerror = rej;
    fr.readAsDataURL(file);
  });
}

async function evEnviar(){
  const section = qs("#evolucao");
  const pending = section.dataset.pendingStage || "";
  const canInteract = section.dataset.canInteract === "1";

  if (!pending) return alert("Voc√™ j√° concluiu todas as etapas.");
  if (!canInteract) return alert("Ainda n√£o √© poss√≠vel enviar nesta etapa.");

  const chosen = Array.from(document.querySelectorAll("#evFilesWrap input[type='file']"))
    .map(i=>i.files && i.files[0]).filter(Boolean);

  if (!chosen.length) return alert("Envie pelo menos 1 imagem.");
  if (chosen.length > EV_MAX_FILES) return alert(`M√°ximo de ${EV_MAX_FILES} imagens.`);

if (pending === "2"){
  const chk = qs("#chkAutorizo");
  if (!chk || !chk.checked){
    evSetAuthError(true); // üî¥ fica vermelho
    return;
  }
  evSetAuthError(false);
}


setLoading(true, "Separando sua evolu√ß√£o...");
startEvLoadingMessageRotation();


  try{
    const files = [];
    for (const f of chosen){
      const b64 = await evToBase64(f);
      files.push({ name:f.name, type:f.type, content:b64 });
    }

    const payload = {
      action: "uploadEvolucao",
      curso: sessao.curso,
      email: sessao.email,
      nome: bootstrap.nome || "",
      stage: pending,
autorizacao: (pending === "2") ? !!qs("#chkAutorizo")?.checked : false,

      files
    };

    const r = await fetch(API_URL, { method:"POST", body: JSON.stringify(payload) });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const d = await r.json();

if (!d.ok){
  if (d.message === "need_authorization"){
    evSetAuthError(true); // üî¥ texto da autoriza√ß√£o fica vermelho (sem alert)
    return;
  }
  if (d.message === "stage_locked") alert("Essa etapa ainda n√£o foi liberada.");
  else if (d.message === "stage_not_pending") alert("Essa n√£o √© a etapa pendente atual.");
  else alert("Erro: " + (d.message || "falha"));
  return;
}


// atualiza bootstrap.evolucao com a resposta (SEM PERDER comments)
if (d.evolucao){
  const prevEv = (bootstrap && bootstrap.evolucao) ? bootstrap.evolucao : null;

  bootstrap.evolucao = {
    ...(prevEv || {}),      // mant√©m comments e qualquer campo j√° existente
    ...d.evolucao,          // aplica o estado novo vindo do servidor
    comments: (prevEv && prevEv.comments) ? prevEv.comments : (d.evolucao.comments || null)
  };
}
// ‚úÖ s√≥ atualiza allowUpload/tokens/feedback, sem sobrescrever bootstrap.evolucao rec√©m-retornado
refreshBootstrap().catch(console.error);



// ‚úÖ grava a confirma√ß√£o (para sobreviver ao re-render)
__evLastSuccess = {
  at: Date.now(),
  html: `
    <div class="sucesso-msg">
      <h3 style="margin:0 0 6px;">‚úÖ Enviado!</h3>
      <p style="margin:0;">Suas imagens foram registradas nesta etapa.</p>
    </div>
  `
};
evRenderButton();

// üî¥ N√ÉO chame refreshBootstrap aqui
// o estado correto j√° est√° em bootstrap.evolucao (d.evolucao)

// renderiza a p√°gina com o estado rec√©m-atualizado
evRenderPage();

// üî• AGORA SIM o gerador aparece imediatamente
evFinal_showIfDone();

// garante que veja o topo
window.scrollTo({ top: 0, behavior: "smooth" });


    
  } catch(e){
    console.error(e);
    alert("Falha ao enviar: " + (e?.message || e));
} finally {
  clearEvLoadingMessageRotation();
  setLoading(false);
}
}

// funcao do gerador


// =========================
// EVOLU√á√ÉO ‚Äî GERADOR FINAL (COM PRELOAD + CACHE + M√ÅSCARA CORRETA)
// =========================
const EV_FINAL_FRAME_SRC = "assets/frameevolucao.png";

// ‚úÖ Ligue para ver guias vermelhas e ajustar x/y/w/h da m√°scara
const EV_FINAL_DEBUG = false;

const evFinal = {
  frameImg: null,
  beforeIdx: 0,
  afterIdx: 0,
  beforePan: 0.5,
  afterPan: 0.5,
  beforeUrls: [],
  afterUrls: [],
  _imgCache: new Map(),
  _loading: false,
  _raf: 0,
};



// ‚úÖ M√ÅSCARA FINAL ‚Äî medidas reais do frame (1080x1350)
const EV_FINAL_MASK = {
  LEFT: {
    x: 10,          // margem esquerda
    y: 10,          // margem superior
    w: 536 - 10,    // at√© o centro, com leve folga
    h: 1179         // 1350 - 10(top) - 161(bottom)
  },
  RIGHT: {
    x: 536 + 10,    // centro + folga
    y: 10,
    w: 1080 - (536 + 10) - 10, // at√© a borda direita
    h: 1179
  }
};




function evFinal_loadImg(src){
  return new Promise((res, rej)=>{
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = ()=>res(img);
    img.onerror = rej;
    img.src = src;
  });
}

function evFinal_driveId(url){
  const s = String(url||"").trim();
  let m = s.match(/\/d\/([a-zA-Z0-9_-]{10,})/);
  if (m) return m[1];
  m = s.match(/[?&]id=([a-zA-Z0-9_-]{10,})/);
  if (m) return m[1];
  return "";
}

async function fetchJsonWithTimeout(url, ms = 20000){
  const ctl = new AbortController();
  const t = setTimeout(() => ctl.abort(), ms);

  try{
    const r = await fetch(url, { cache: "no-store", signal: ctl.signal });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return await r.json();
  } finally {
    clearTimeout(t);
  }
}

async function evFinal_getDataUrl(fileUrl){
  const id = evFinal_driveId(fileUrl);
  if (!id) return fileUrl;

  const tries = 3;
  let lastErr = null;

  for (let i = 0; i < tries; i++){
    try{
      const url = `${API_URL}?action=getEvoImageB64&id=${encodeURIComponent(id)}&t=${Date.now()}_${i}`;
      const d = await fetchJsonWithTimeout(url, 20000);

      if (!d || !d.ok || !d.b64) throw new Error("getEvoImageB64_failed");
      const mime = d.mime || "image/jpeg";
      return `data:${mime};base64,${d.b64}`;
    } catch (e){
      lastErr = e;
      await new Promise(r => setTimeout(r, 600 * (i + 1)));
    }
  }

  console.warn("evFinal_getDataUrl falhou, usando URL original:", lastErr);
  return fileUrl;
}


async function evFinal_getImg(originalUrl){
  if (!originalUrl) return null;
  if (evFinal._imgCache.has(originalUrl)) return evFinal._imgCache.get(originalUrl);

  const dataUrl = await evFinal_getDataUrl(originalUrl);
  const img = await evFinal_loadImg(dataUrl);
  evFinal._imgCache.set(originalUrl, img);
  return img;
}

async function evFinal_ensureFrame(){
  if (evFinal.frameImg) return evFinal.frameImg;
  evFinal.frameImg = await evFinal_loadImg(EV_FINAL_FRAME_SRC);
  return evFinal.frameImg;
}

// cover que preenche 100% e centraliza (focalY=0.5 => n√£o ‚Äúgruda no topo‚Äù)
function evFinal_drawCover(ctx, img, dx, dy, dw, dh, panX = 0.5){
  const iw = img.naturalWidth || img.width;
  const ih = img.naturalHeight || img.height;
  if (!iw || !ih) return;

  // üîí trava pela ALTURA da m√°scara
  const scale = dh / ih;

  const sw = iw * scale;
  const sh = ih * scale;

  // nunca pan vertical
  const sy = dy;

  // pan horizontal (0 = esquerda | 0.5 = centro | 1 = direita)
  const maxOffset = Math.max(0, sw - dw);
  const offsetX = maxOffset * panX;

  const sx = dx - offsetX;

  ctx.drawImage(img, sx, sy, sw, sh);
}


function evFinal_scheduleRender(){
  if (evFinal._raf) cancelAnimationFrame(evFinal._raf);
  evFinal._raf = requestAnimationFrame(()=>{
    evFinal._raf = 0;
    evFinal_render().catch(console.error);
  });
}

function evFinal_setCardVisible(visible){
  const wrap = qs("#evFinalWrap");
  if (!wrap) return;
  wrap.classList.toggle("hidden", !visible);
}

function evFinal_setInlineStatus(text){
  const wrap = qs("#evFinalWrap");
  if (!wrap) return;

  let el = qs("#evFinalInlineStatus");
  if (!el){
    el = document.createElement("div");
    el.id = "evFinalInlineStatus";
    el.className = "hint";
    el.style.marginTop = "10px";
    el.style.textAlign = "center";
    wrap.querySelector(".ev-block")?.appendChild(el);
  }

  if (!text){
    el.style.display = "none";
    el.textContent = "";
  } else {
    el.style.display = "block";
    el.textContent = text;
  }
}

async function evFinal_preloadAll(){
  if (evFinal._loading) return;
  evFinal._loading = true;

  // ‚úÖ O gerador S√ì vai ser chamado quando concluir (pendingStage vazio).
  // Aqui a gente s√≥ evita travar a tela com overlay eterno.
  evFinal_setCardVisible(true);
  evFinal_setInlineStatus("Carregando imagens do gerador‚Ä¶");

  try{
    await evFinal_ensureFrame();

    const list = [...new Set([...(evFinal.beforeUrls||[]), ...(evFinal.afterUrls||[])])];
    await Promise.all(list.map(u => evFinal_getImg(u).catch(()=>null)));
  } finally {
    evFinal._loading = false;
    evFinal_setInlineStatus("");
  }

  evFinal_scheduleRender();
}


// ‚úÖ desenha com m√°scara correta (duas janelas)
async function evFinal_render(){
  const canvas = qs("#evFinalCanvas");
  if (!canvas) return;
  const ctx = canvas.getContext("2d");
  const W = canvas.width, H = canvas.height;

  ctx.clearRect(0,0,W,H);

  const left  = EV_FINAL_MASK.LEFT;
  const right = EV_FINAL_MASK.RIGHT;

  // (1) desenha as imagens dentro do CLIP
  const beforeUrl = evFinal.beforeUrls[evFinal.beforeIdx] || "";
  const afterUrl  = evFinal.afterUrls[evFinal.afterIdx]   || "";

  if (beforeUrl){
    const img = await evFinal_getImg(beforeUrl).catch(()=>null);
    if (img){
      ctx.save();
      ctx.beginPath();
      ctx.rect(left.x, left.y, left.w, left.h);
      ctx.clip();
evFinal_drawCover(ctx, img, left.x, left.y, left.w, left.h, evFinal.beforePan);

      ctx.restore();
    }
  }

  if (afterUrl){
    const img = await evFinal_getImg(afterUrl).catch(()=>null);
    if (img){
      ctx.save();
      ctx.beginPath();
      ctx.rect(right.x, right.y, right.w, right.h);
      ctx.clip();
evFinal_drawCover(ctx, img, right.x, right.y, right.w, right.h, evFinal.afterPan);

      ctx.restore();
    }
  }

  // (2) frame por cima sempre
  const frame = await evFinal_ensureFrame().catch(()=>null);
  if (frame) ctx.drawImage(frame, 0, 0, W, H);

  // (3) debug: desenha guias vermelhas pra acertar m√°scara
  if (EV_FINAL_DEBUG){
    ctx.save();
    ctx.lineWidth = 6;
    ctx.strokeStyle = "red";
    ctx.strokeRect(left.x, left.y, left.w, left.h);
    ctx.strokeRect(right.x, right.y, right.w, right.h);
    ctx.restore();
  }
}

// troca de imagem sem ‚Äúsumir tudo‚Äù
// - se j√° est√° no cache, n√£o usa overlay e troca instant√¢nea
// - se n√£o estiver (caso preload falhe), mostra overlay s√≥ durante a busca
async function evFinal_change(side){ // "before" | "after"
  const isBefore = side === "before";
  const arr = isBefore ? evFinal.beforeUrls : evFinal.afterUrls;
  if (!arr || !arr.length) return;

  const nextIdx = isBefore
    ? (evFinal.beforeIdx + 1) % arr.length
    : (evFinal.afterIdx + 1) % arr.length;

  const nextUrl = arr[nextIdx];

  // se n√£o tiver no cache, mostra overlay (ideal √© nunca cair aqui, pois preload carrega tudo)
  const hasCache = evFinal._imgCache.has(nextUrl);

  if (!hasCache) setLoading(true, "Carregando imagem...");
  try{
    await evFinal_getImg(nextUrl); // garante pronta
    if (isBefore) evFinal.beforeIdx = nextIdx;
    else evFinal.afterIdx = nextIdx;

    evFinal_scheduleRender();
  } finally {
    if (!hasCache) setLoading(false);
  }
}

// =========================
// mostra/esconde e liga os bot√µes (s√≥ quando conclu√≠do)
// =========================
function evFinal_showIfDone(){
  const wrap = qs("#evFinalWrap");
  if (!wrap) return;

  const done = !bootstrap?.evolucao?.pendingStage;
  if (!done){
    wrap.classList.add("hidden");
    return;
  }

  const imgs = bootstrap?.evolucao?.images || {};
  evFinal.beforeUrls = Array.isArray(imgs.antes) ? imgs.antes : [];
  evFinal.afterUrls  = Array.isArray(imgs["11"]) ? imgs["11"] : [];

  if (!evFinal.beforeUrls.length || !evFinal.afterUrls.length){
    wrap.classList.add("hidden");
    return;
  }

  // configura estado inicial
  evFinal.beforeIdx = 0;
  evFinal.afterIdx  = 0;
  evFinal.beforeZoom = Number(qs("#evFinalZoomAntes")?.value || 1);
  evFinal.afterZoom  = Number(qs("#evFinalZoomDepois")?.value || 1);

const btnAntes  = qs("#evFinalPrevAntes");
const btnDepois = qs("#evFinalNextDepois");

// s√≥ mostra se fizer sentido
btnAntes.style.display  = evFinal.beforeUrls.length > 1 ? "inline-block" : "none";
btnDepois.style.display = evFinal.afterUrls.length  > 1 ? "inline-block" : "none";

btnAntes.onclick  = ()=> evFinal_change("before");
btnDepois.onclick = ()=> evFinal_change("after");


qs("#evFinalZoomAntes").oninput = (e)=>{
  evFinal.beforePan = Number(e.target.value || 0.5);
  evFinal_scheduleRender();
};

qs("#evFinalZoomDepois").oninput = (e)=>{
  evFinal.afterPan = Number(e.target.value || 0.5);
  evFinal_scheduleRender();
};

  // ‚úÖ Preload antes de mostrar o card
  evFinal_preloadAll().catch(console.error);
}

  // =========================
  // BAIXAR IMAGEM
  // =========================
  const btnDownload = qs("#evFinalDownload");
  if (btnDownload){
    btnDownload.onclick = async () => {
      const canvas = qs("#evFinalCanvas");
      if (!canvas) return;

      const blob = await new Promise(res =>
        canvas.toBlob(res, "image/png", 1)
      );

      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "minha-evolucao.png";
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 1500);
    };
  }

  // =========================
  // COMPARTILHAR IMAGEM
  // =========================
  const btnShare = qs("#evFinalShare");
  if (btnShare){
    btnShare.onclick = async () => {
      const canvas = qs("#evFinalCanvas");
      if (!canvas) return;

      const blob = await new Promise(res =>
        canvas.toBlob(res, "image/png", 1)
      );

      const file = new File([blob], "minha-evolucao.png", {
        type: "image/png"
      });

      // Web Share API (celular)
      if (
        navigator.share &&
        navigator.canShare &&
        navigator.canShare({ files: [file] })
      ){
        await navigator.share({
          files: [file],
          title: "Minha evolu√ß√£o",
          text: "Minha evolu√ß√£o no curso"
        });
        return;
      }

      // fallback: download
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "minha-evolucao.png";
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 1500);
    };
  }


  
function abrirEvolucao(){
  if (!evEnabled()){
    alert("Recurso indispon√≠vel no momento.");
    return;
  }
  evShowSection();
  evRenderPage();
}


/* --------- bootstrap do DOM --------- */
document.addEventListener("DOMContentLoaded", async () => {
  try { sessao = JSON.parse(localStorage.getItem("sessao_portal") || "null"); } catch {}
  if (!sessao || !sessao.email || !sessao.curso) {
    alert("Fa√ßa login para acessar.");
    location.replace("index.html");
    return;
  }

  setLoading(true, "Carregando as informa√ß√µes...");
  await carregarBootstrap(sessao.curso, sessao.email);
  setLoading(false);

  // handlers
  qs("#btnAbrirEnvio").onclick = abrirEnvio;
  qs("#btnVoltarEnvio").onclick = () => { hide(qs("#envio")); show(qs("#dashboard")); window.scrollTo({top:0,behavior:"smooth"}); };
  qs("#btnAddImagem").onclick  = addFileInput;
  qs("#btnResetar").onclick    = resetFiles;
  qs("#btnEnviar").onclick     = enviarExercicio;
  qs("#btnVoltarMenu").onclick = () => { hide(qs("#sucesso")); show(qs("#dashboard")); };
  qs("#btnSair").onclick       = () => { localStorage.removeItem("sessao_portal"); location.replace("index.html"); };

  qs("#btnSalvarPhone").onclick   = savePhone;
  qs("#btnCancelarPhone").onclick = hidePhoneModal;
  qs("#phoneInput").addEventListener("input", e => { e.target.value = formatBRPhone(e.target.value); });

  qs("#filesWrap").addEventListener("change", () => updateUIForTokens());
  document.addEventListener("visibilitychange", () => { if (!document.hidden) refreshBootstrap(); });

  // evolu√ß√£o
  const btnEv = qs("#btnEvolucao");
  if (btnEv) btnEv.onclick = abrirEvolucao;

  qs("#evVoltar").onclick = evBackToMenu;
  qs("#evReset").onclick  = evResetFiles;
  qs("#evEnviar").onclick = evEnviar;

  qs("#evCloseModal").onclick = evCloseModal;
  qs("#evOpenAllStage").onclick = evOpenAllFromModalStage;

  qs("#evImgModal").addEventListener("click", (ev)=>{
    if (ev.target && ev.target.id === "evImgModal") evCloseModal();
  });

  // re-render button quando bootstrap carregar
  evRenderButton();

  
  updateAddBtnVisibility();
  updateLiveBadgeFromBootstrap();
  setInterval(updateLiveBadgeFromBootstrap, 15_000);

const chkAut = qs("#chkAutorizo");
if (chkAut){
  chkAut.addEventListener("change", () => {
    if (chkAut.checked){
      evSetAuthError(false);
    }
  });
}

  
});
</script>
 
  <!-- Overlay global -->
  <script>
    function setLoading(state, msg = "Carregando‚Ä¶") {
      const box = document.getElementById("global-loading");
      const bubble = box ? box.querySelector(".global-loading-bubble") : null;
      if (bubble) bubble.textContent = msg;
      document.querySelectorAll("[data-busy]").forEach(el => el.disabled = !!state);
      if (box) box.style.display = state ? "grid" : "none";
    }
  </script>

  <div id="global-loading" aria-live="polite" aria-busy="true" style="display:none">
    <div class="global-loading-bubble">Carregando‚Ä¶</div>
  </div>
</body>
</html>





























































